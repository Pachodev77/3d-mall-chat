<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <meta name="full-screen" content="yes">
    <meta name="x5-fullscreen" content="true">
    <meta name="browsermode" content="application">
    <meta name="x5-page-mode" content="app">
    <title>Paseo Virtual por Centro Comercial</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #000;
        }
        canvas {
            display: block;
        }
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background-color: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            mix-blend-mode: difference;
            z-index: 5;
        }
        #chat-toggle-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            width: 36px;
            height: 36px;
            background: #222;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 20px;
            transition: background 0.2s;
        }
        #chat-toggle-btn:hover {
            background: #444;
        }
        #chat-panel {
            position: fixed;
            top: 60px;
            left: 16px;
            width: 480px;
            max-width: 90vw;
            height: 600px;
            background: rgba(30,30,30,0.85);
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.4);
            z-index: 1003;
            display: none;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        #chat-header {
            background: rgba(24,24,24,0.9);
            color: #fff;
            padding: 12px 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        #chat-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        #chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        #users-sidebar {
            width: 140px;
            background: rgba(34,34,34,0.9);
            border-left: 1px solid #333;
            padding: 8px;
            overflow-y: auto;
        }
        #users-title {
            color: #aaa;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
        }
        .user-item {
            color: #fff;
            font-size: 12px;
            padding: 4px 6px;
            margin-bottom: 2px;
            border-radius: 4px;
            background: #333;
            border-left: 3px solid transparent;
        }
        #emoji-panel {
            position: absolute;
            bottom: 70px;
            left: 10px;
            right: 10px;
            background: rgba(51,51,51,0.95);
            border-radius: 8px;
            padding: 10px;
            display: none;
            flex-wrap: wrap;
            gap: 4px;
            max-height: 140px;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }
        .emoji-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .emoji-btn:hover {
            background: #555;
        }
        #emoji-toggle {
            background: none;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            margin-right: 4px;
        }
        #chat-close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }
        #chat-messages {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            color: #eee;
            font-size: 15px;
        }
        #chat-input-area {
            display: flex;
            border-top: 1px solid #333;
            background: rgba(34,34,34,0.9);
            padding: 10px;
        }
        #chat-input {
            flex: 1;
            border: none;
            background: #333;
            color: #fff;
            border-radius: 6px;
            padding: 8px;
            font-size: 15px;
        }
        #chat-send-btn {
            background: #4B0000;
            color: #fff;
            border: none;
            border-radius: 6px;
            margin-left: 8px;
            padding: 8px 14px;
            font-size: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        #chat-send-btn:hover {
            background: #800000;
        }
        #alias-prompt {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1002;
        }
        #alias-prompt input {
            padding: 10px;
            font-size: 16px;
            border-radius: 6px;
            border: none;
            margin-bottom: 12px;
        }
        #alias-prompt button {
            padding: 8px 18px;
            font-size: 15px;
            border-radius: 6px;
            border: none;
            background: #4B0000;
            color: #fff;
            cursor: pointer;
        }
        #change-alias-btn {
            position: fixed;
            top: 16px;
            left: 60px;
            width: 36px;
            height: 36px;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 16px;
            transition: background 0.2s;
        }
        #change-alias-btn:hover {
            background: #555;
        }
        
        .chat-message {
            padding: 6px 10px;
            border-radius: 8px;
            margin-bottom: 4px;
            background: rgba(40,40,40,0.7);
            display: inline-block;
            max-width: 90%;
            word-break: break-word;
        }
        .chat-message.own {
            background: linear-gradient(90deg, #FFD70033, #FFD70011);
        }

        /* --- Estilos para el panel de personalización (Pixel Art y Moderno combinado) --- */
        #customization-panel {
          font-family: 'Press Start 2P', 'VT323', 'Courier New', monospace;
          font-size: 12px;
          border-radius: 0;
          border: 4px solid #222;
          background: #181818;
          animation: slideIn 0.3s ease-out;
        }
        #customization-panel h3 {
          font-size: 13px;
          letter-spacing: 1px;
          margin: 0 0 10px 0;
          color: #FFD700;
          text-shadow: none;
        }
        #customization-panel input {
          font-family: inherit;
          font-size: 12px;
          padding: 6px 8px;
          border: 2px solid #444;
          border-radius: 0;
          background: #222;
          color: #fff;
          box-shadow: none;
          outline: none;
        }
        #customization-panel button {
          font-family: inherit;
          font-size: 12px;
          padding: 6px 12px;
          border: 2px solid #FFD700;
          border-radius: 0;
          background: #222;
          color: #FFD700;
          box-shadow: none;
          cursor: pointer;
          margin: 2px 0;
          transition: background 0.1s, color 0.1s;
        }
        #customization-panel button:hover {
          background: #FFD700;
          color: #222;
        }
        #avatar-preview {
          width: 80px;
          height: 110px;
          border: 2px solid #FFD700;
          background: #111;
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 auto;
          border-radius: 0;
          box-shadow: none;
        }
        #avatar-preview * {
          font-family: inherit;
          font-size: 10px;
          border-radius: 0;
          box-shadow: none;
        }
        
        /* Estilos para los botones de color */
        .color-btn {
          width: 45px;
          height: 45px;
          border: 3px solid #444;
          border-radius: 10px;
          margin: 2px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
          transition: all 0.2s ease-in-out;
          cursor: pointer;
          position: relative;
        }
        .color-btn.selected, .color-btn:hover {
          border-color: #FFD700;
          transform: scale(1.1);
          box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
        }
        
        #preview-alias {
          font-size: 10px;
          color: #FFD700;
          background: #111;
          border: 2px solid #FFD700;
          border-radius: 0;
          padding: 4px 0;
          margin: 4px 0;
        }
        
        /* Animaciones para el panel */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
    </style>
</head>
<body>
    <div id="ui-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1002; pointer-events:auto;"></div>
    <div id="crosshair"></div>
    <button id="chat-toggle-btn" title="Abrir chat">💬</button>
    <button id="change-alias-btn" title="Personalizar avatar">👤</button>
    
    <div id="customization-panel" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 900px; max-width: 95vw; height: 650px; background: linear-gradient(135deg, rgba(20,20,20,0.98), rgba(30,30,30,0.98)); border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); z-index: 1004; display: none; flex-direction: column; overflow: hidden; backdrop-filter: blur(20px); border: 2px solid #4B0000;">
        <div style="background: linear-gradient(135deg, #4B0000, #800000); color: #fff; padding: 20px; font-weight: bold; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #FFD700;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 24px;">👤</span>
                <span style="font-size: 20px; text-transform: uppercase; letter-spacing: 2px;">Personalizar Avatar</span>
            </div>
            <button id="customization-close-btn" style="background: rgba(255,255,255,0.1); border: none; color: #fff; font-size: 20px; cursor: pointer; padding: 8px; border-radius: 8px; transition: all 0.3s; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">✖</button>
        </div>
        
        <div style="flex: 1; padding: 30px; overflow-y: auto; color: #eee; display: grid; grid-template-columns: 1fr 300px; gap: 30px;">
            <div style="display: flex; flex-direction: column; gap: 25px;">
                <div style="padding: 25px; background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(50,50,50,0.8)); border-radius: 12px; border-left: 5px solid #FFD700; box-shadow: 0 4px 16px rgba(0,0,0,0.3);">
                    <h3 style="margin: 0 0 20px 0; color: #FFD700; font-size: 18px; text-transform: uppercase; letter-spacing: 1px;">📝 Nombre del Avatar</h3>
                    <p style="margin-bottom: 15px; color: #ccc; font-size: 14px;">Nombre actual: <strong id="current-alias" style="color: #FFD700; font-size: 16px;">Sin nombre</strong></p>
                    <input type="text" id="customization-alias-input" placeholder="Escribe tu nombre..." maxlength="20" style="width: 100%; padding: 15px; font-size: 16px; border-radius: 8px; border: 2px solid #333; background: rgba(20,20,20,0.8); color: #fff; box-sizing: border-box; transition: all 0.3s; outline: none;" onfocus="this.style.borderColor='#FFD700'" onblur="this.style.borderColor='#333'">
                </div>
                
                <div style="padding: 25px; background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(50,50,50,0.8)); border-radius: 12px; border-left: 5px solid #FFD700;">
                    <h3 style="margin: 0 0 20px 0; color: #FFD700; font-size: 18px;">👕 Color de Camisa</h3>
                    <div id="shirt-color-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 10px;">
                        <button onclick="changeShirtColor(this, 0xFF6B6B)" class="color-btn" data-color="0xFF6B6B" style="background: #FF6B6B;"></button>
                        <button onclick="changeShirtColor(this, 0x4ECDC4)" class="color-btn" data-color="0x4ECDC4" style="background: #4ECDC4;"></button>
                        <button onclick="changeShirtColor(this, 0x45B7D1)" class="color-btn" data-color="0x45B7D1" style="background: #45B7D1;"></button>
                        <button onclick="changeShirtColor(this, 0x96CEB4)" class="color-btn" data-color="0x96CEB4" style="background: #96CEB4;"></button>
                        <button onclick="changeShirtColor(this, 0xFFEAA7)" class="color-btn" data-color="0xFFEAA7" style="background: #FFEAA7;"></button>
                        <button onclick="changeShirtColor(this, 0xDDA0DD)" class="color-btn" data-color="0xDDA0DD" style="background: #DDA0DD;"></button>
                        <button onclick="changeShirtColor(this, 0x98D8C8)" class="color-btn" data-color="0x98D8C8" style="background: #98D8C8;"></button>
                        <button onclick="changeShirtColor(this, 0xF7DC6F)" class="color-btn" data-color="0xF7DC6F" style="background: #F7DC6F;"></button>
                        <button onclick="changeShirtColor(this, 0xBB8FCE)" class="color-btn" data-color="0xBB8FCE" style="background: #BB8FCE;"></button>
                        <button onclick="changeShirtColor(this, 0x85C1E9)" class="color-btn" data-color="0x85C1E9" style="background: #85C1E9;"></button>
                        <button onclick="changeShirtColor(this, 0xF8C471)" class="color-btn" data-color="0xF8C471" style="background: #F8C471;"></button>
                        <button onclick="changeShirtColor(this, 0x82E0AA)" class="color-btn" data-color="0x82E0AA" style="background: #82E0AA;"></button>
                    </div>
                </div>
                
                <div style="padding: 25px; background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(50,50,50,0.8)); border-radius: 12px; border-left: 5px solid #FFD700;">
                    <h3 style="margin: 0 0 20px 0; color: #FFD700; font-size: 18px;">👖 Color de Pantalón</h3>
                    <div id="pants-color-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 10px;">
                        <button onclick="changePantsColor(this, 0x2C3E50)" class="color-btn" data-color="0x2C3E50" style="background: #2C3E50;"></button>
                        <button onclick="changePantsColor(this, 0x34495E)" class="color-btn" data-color="0x34495E" style="background: #34495E;"></button>
                        <button onclick="changePantsColor(this, 0x8B4513)" class="color-btn" data-color="0x8B4513" style="background: #8B4513;"></button>
                        <button onclick="changePantsColor(this, 0x654321)" class="color-btn" data-color="0x654321" style="background: #654321;"></button>
                        <button onclick="changePantsColor(this, 0x2F4F4F)" class="color-btn" data-color="0x2F4F4F" style="background: #2F4F4F;"></button>
                        <button onclick="changePantsColor(this, 0x696969)" class="color-btn" data-color="0x696969" style="background: #696969;"></button>
                        <button onclick="changePantsColor(this, 0x556B2F)" class="color-btn" data-color="0x556B2F" style="background: #556B2F;"></button>
                        <button onclick="changePantsColor(this, 0x8B0000)" class="color-btn" data-color="0x8B0000" style="background: #8B0000;"></button>
                        <button onclick="changePantsColor(this, 0x4B0082)" class="color-btn" data-color="0x4B0082" style="background: #4B0082;"></button>
                        <button onclick="changePantsColor(this, 0x191970)" class="color-btn" data-color="0x191970" style="background: #191970;"></button>
                        <button onclick="changePantsColor(this, 0x006400)" class="color-btn" data-color="0x006400" style="background: #006400;"></button>
                        <button onclick="changePantsColor(this, 0x000000)" class="color-btn" data-color="0x000000" style="background: #000000;"></button>
                    </div>
                </div>
                 <div style="padding: 25px; background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(50,50,50,0.8)); border-radius: 12px; border-left: 5px solid #FFD700;">
                    <h3 style="margin: 0 0 20px 0; color: #FFD700; font-size: 18px;">👞 Color de Zapatos</h3>
                    <div id="shoes-color-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 10px;">
                        <button onclick="changeShoesColor(this, 0x8B4513)" class="color-btn" data-color="0x8B4513" style="background: #8B4513;"></button>
                        <button onclick="changeShoesColor(this, 0x654321)" class="color-btn" data-color="0x654321" style="background: #654321;"></button>
                        <button onclick="changeShoesColor(this, 0x000000)" class="color-btn" data-color="0x000000" style="background: #000000;"></button>
                        <button onclick="changeShoesColor(this, 0x2F4F4F)" class="color-btn" data-color="0x2F4F4F" style="background: #2F4F4F;"></button>
                        <button onclick="changeShoesColor(this, 0x696969)" class="color-btn" data-color="0x696969" style="background: #696969;"></button>
                        <button onclick="changeShoesColor(this, 0x8B0000)" class="color-btn" data-color="0x8B0000" style="background: #8B0000;"></button>
                        <button onclick="changeShoesColor(this, 0x4B0082)" class="color-btn" data-color="0x4B0082" style="background: #4B0082;"></button>
                        <button onclick="changeShoesColor(this, 0x191970)" class="color-btn" data-color="0x191970" style="background: #191970;"></button>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 25px;">
                 <div style="padding: 25px; background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(50,50,50,0.8)); border-radius: 12px; border-left: 5px solid #FFD700; text-align: center;">
                    <h3 style="margin: 0 0 20px 0; color: #FFD700; font-size: 18px;">👤 Vista Previa</h3>
                    <div id="avatar-preview" style="width: 150px; height: 200px; margin: 0 auto; background: #222; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid #333;">
                        <div style="color: #ccc; font-size: 14px;">Avatar</div>
                    </div>
                </div>
                <div style="padding: 25px; background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(50,50,50,0.8)); border-radius: 12px; border-left: 5px solid #FFD700; text-align: center;">
                    <h3 style="margin: 0 0 20px 0; color: #FFD700; font-size: 18px;">📝 Nombre Actual</h3>
                    <div id="preview-alias" style="color: #fff; font-size: 18px; font-weight: bold; padding: 15px; background: #111; border-radius: 8px; border: 2px solid #FFD700;">Sin nombre</div>
                </div>
            </div>
        </div>
        
        <div style="padding: 20px 30px; background: #1a1a1a; border-top: 2px solid #333; display: flex; gap: 15px; justify-content: flex-end;">
            <button id="reset-customization-btn" style="padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; background: #555; color: #fff;">🔄 Restablecer</button>
            <button id="save-customization-btn" style="padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; background: #800000; color: #fff;">💾 Guardar</button>
        </div>
    </div>

    <div id="chat-panel">
        <div id="chat-header">
            Chat
            <button id="chat-close-btn" title="Cerrar">✖</button>
        </div>
        <div id="chat-content">
            <div id="chat-main">
                <div id="chat-messages"></div>
                <div id="chat-input-area">
                    <button id="emoji-toggle" title="Emojis">😊</button>
                    <input id="chat-input" type="text" placeholder="Escribe un mensaje..." autocomplete="off" />
                    <button id="chat-send-btn">Enviar</button>
                </div>
                <div id="emoji-panel"></div>
            </div>
            <div id="users-sidebar">
                <div id="users-title">Usuarios</div>
                <div id="users-list"></div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="/firebase-config.js"></script>
    <script>
        // URLs de las tiendas proporcionadas por el usuario (duplicadas para llenar todos los pisos)
        const originalStoreLinks = [
            "https://www.ipweb.pro/en/?Davincho88", "https://ipgold.biz/?r=meramente42@gmail.com", "https://surfe.be/ext/2837287",
            "https://sproutgigs.com/?a=0675642e", "https://r.adbtc.top/2847448", "https://www.coinpayu.com/?r=everest101",
            "https://surfio.site/i/794", "https://serfclick.net/i/277142", "https://faucetcrypto.com/r/1373767",
            "https://earnbitmoon.club/?ref=1075373", "https://viefaucet.com?r=6383ddeaec6d7776fc69e555", "https://simplebits.io/ref/OLkiv6stfLj_",
            "https://tap-coin.de/refer/user/4365", "https://btcadspace.com/ref/p4ch3c0", "https://trustdice.win/faucet/?ref=u_mapachox101",
            "http://cointiply.com/r/4yDJAp", "https://autofaucet.dutchycorp.space/?r=sakreto", "https://freebitco.in/?r=49843181",
            "https://faucetpay.io/?r=2136351", "https://r.honeygain.me/MERAM588A9", "https://pawns.app/?r=585883",
            "https://teaserfast.ru/u/mapachox", "https://addon.money/p/343495", "https://everve.net/ref/961754/",
            "https://swashapp.io/download?referral_code=3opl7k4ztf53", "https://addslice.com/?crew=JHVJ6", "https://earnapp.com/i/4zbftm2",
            "https://node.optimai.network/register?ref=F471454F", "https://dashboard.teneo.pro/auth/signup?referralCode=ERPr2", "https://app.nodepay.ai/register?ref=kOYHwfDuFNSSZg2",
            "https://www.jumptask.io/r/budapygirazu", "https://payeer.com/?partner=23994523", "https://rollercoin.com/?r=m9dnpgsp",
            "https://bux.money/u/239006", "https://www.swagbucks.com/p/register?rb=119244201&rp=1", "https://app.getgrass.io/register?referralCode=SwWRadefuICY8DI",
            "https://freecash.com/r/116249823271721789104", "https://r.honeygain.me/AIRRIFADB7", "https://www.binance.com/referral/earn-together/refertoearn2000usdc/claim?hl=en&ref=GRO_14352_ZBFKF",
            "https://www.paidwork.com/?r=meramente42", "https://www.bybit.com/invite?ref=VWN6NL", "https://app-earnings-link.com/givvyMusic/hoty216dfkvisgv",
            "https://swcapp.com/i/davehz", "https://app-earnings-link.com/givvyStream/a6dd8fsmn6t6qhfjjw5", "https://app-earnings-link.com/givvyScratchCardNew/euz9t4x3bmk6"
        ];
        
        const domainToLogoMap = {
            'ipweb': 'ipweb-logo.png', 'ipgold': 'ipgold-logo.png', 'surfe': 'surfe-logo.png', 'sproutgigs': 'sproutgigs-logo.png',
            'adbtc': 'adbtc-logo.png', 'coinpayu': 'coinpayu-logo.png', 'surfio': 'surfio-logo.png', 'serfclick': 'serfclick-logo.png',
            'faucetcrypto': 'faucetcrypto-logo.png', 'earnbitmoon': 'earnbitmoon-logo.png', 'viefaucet': 'viefaucet-logo.png', 'simplebits': 'simplebits-logo.png',
            'tap-coin': 'tapcoin-logo.png', 'btcadspace': 'btcadspace-logo.png', 'trustdice': 'trustdice-logo.png', 'cointiply': 'cointiply-logo.png',
            'autofaucet': 'autofaucet-logo.png', 'freebitco': 'freebitcoin-logo.png', 'faucetpay': 'faucetpay-logo.png', 'honeygain': 'honeygain-logo.png',
            'pawns': 'pawns-logo.png', 'teaserfast': 'teaserfast-logo.png', 'addon': 'addonmoney-logo.png', 'everve': 'everve-logo.png',
            'swashapp': 'swash-logo.png', 'addslice': 'addslice-logo.png', 'earnapp': 'earnapp-logo.png', 'optimai': 'optimai-logo.png',
            'teneo': 'teneo-logo.png', 'nodepay': 'nodepay-logo.png', 'jumptask': 'jumptask-logo.png', 'payeer': 'payeer-logo.png',
            'rollercoin': 'rollercoin-logo.png', 'bux': 'buxmoney-logo.png', 'swagbucks': 'swagbucks-logo.png', 'grass': 'grass-logo.png',
            'getgrass': 'grass-logo.png', 'freecash': 'freecash-logo.png', 'binance': 'binance-logo.png', 'paidwork': 'paidwork-logo.png',
            'bybit': 'bybit-logo.png', 'givvyMusic': 'givvymusic-logo.png', 'givvyStream': 'givvystream-logo.png',
            'givvyScratchCardNew': 'givvystream-logo.png', 'swcapp': 'swcapp-logo.png', 'app-earnings-link': 'givvystream-logo.png'
        };

        const storeLinks = [];
        for (let i = 0; i < 5; i++) {
            storeLinks.push(...originalStoreLinks);
        }

        // --- Global Config ---
        const HALL_SIZE = 90;
        const HALL_HEIGHT = 4;
        const MOVE_SPEED = 0.8;
        const ROTATE_SPEED = 0.05; // Slower rotation for more control
        const CAMERA_HEIGHT = 1.6;
        const MAX_FLOOR = 1;
        const MIN_FLOOR = 0;

        // --- Scene Variables ---
        let scene, camera, renderer;
        const clickableObjects = [], collisionObjects = [];
        const keys = { W: false, S: false, A: false, D: false, ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false };
        const userAvatars = new Map();
        
        // --- Avatar Customization ---
        let currentCustomization = {
            alias: '',
            shirtColor: 0x4ECDC4, 
            pantsColor: 0x2C3E50, 
            shoesColor: 0x8B4513 
        };
        let customizationPanelOpen = false;

        // --- Interaction & Movement ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let targetPosition, targetRotationY;
        let currentFloor = 0;
        let shopNumberCounter = 1;

        // --- Mobile Controls ---
        let moveJoystick = { x: 0, y: 0 };
        let cameraJoystick = { x: 0, y: 0 };
        let moveJoystickActive = false;
        let cameraJoystickActive = false;
        
        // --- Cache ---
        const materialCache = new Map(), textureCache = new Map(), logoTextureCache = new Map();

        // --- Helper Functions ---
        const getNextShopNumber = () => shopNumberCounter++;
        const isMobile = () => /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
        
        function getCachedMaterial(color, roughness = 0.8, metalness = 0.2) {
            const key = `${color}-${roughness}-${metalness}`;
            if (!materialCache.has(key)) {
                materialCache.set(key, new THREE.MeshStandardMaterial({ color, roughness, metalness }));
            }
            return materialCache.get(key);
        }

        function getCachedTexture(text, colorIdx, width, height) {
             const key = `${text}-${colorIdx}-${width}-${height}`;
            if (!textureCache.has(key)) {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                const canvasW = Math.min(512, width * 64);
                const canvasH = Math.min(512, height * 64);
                canvas.width = canvasW;
                canvas.height = canvasH;
                
                context.fillStyle = `hsl(${colorIdx * 47 % 360}, 60%, 50%)`;
                context.fillRect(0, 0, canvasW, canvasH);
                
                context.font = `bold ${canvasH * 0.3}px Arial`;
                context.fillStyle = 'white';
                context.textAlign = 'center';
                context.textBaseline = 'middle';
                context.fillText(text.charAt(0).toUpperCase() + text.slice(1), canvasW / 2, canvasH / 2);

                const texture = new THREE.CanvasTexture(canvas);
                textureCache.set(key, texture);
            }
            return textureCache.get(key);
        }

        function getSkyColor() {
            const hour = new Date().getHours();
            if (hour >= 6 && hour < 12) return new THREE.Color(0x87CEEB); // Mañana
            if (hour >= 12 && hour < 18) return new THREE.Color(0x4682B4); // Tarde
            if (hour >= 18 && hour < 20) return new THREE.Color(0xFF7F50); // Atardecer
            if (hour >= 20 && hour < 22) return new THREE.Color(0x191970); // Anochecer
            return new THREE.Color(0x000000); // Noche
        }

        function lerpAngle(a, b, t) {
            let diff = b - a;
            while (diff < -Math.PI) diff += Math.PI * 2;
            while (diff > Math.PI) diff -= Math.PI * 2;
            return a + diff * t;
        }

        function checkCollision(newPosition) {
            const playerBox = new THREE.Box3().setFromCenterAndSize(newPosition, new THREE.Vector3(1.0, CAMERA_HEIGHT, 1.0));
            for (const wallBox of collisionObjects) {
                if (playerBox.intersectsBox(wallBox)) {
                    return true;
                }
            }
            return false;
        }


        // --- Main Init ---
        function init() {
            setupScene();
            setupLighting();
            createMall();
            setupEventListeners();
            setupUI();
            animate();
        }

        function setupScene() {
            scene = new THREE.Scene();
            scene.background = getSkyColor();
            scene.fog = new THREE.Fog(0x1a1a1a, 15, 105);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(25, CAMERA_HEIGHT, 25);
            camera.lookAt(HALL_SIZE / 2, CAMERA_HEIGHT, HALL_SIZE / 2);

            targetPosition = camera.position.clone();
            targetRotationY = camera.rotation.y;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = false;
            document.body.appendChild(renderer.domElement);
        }

        function setupLighting() {
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
            dirLight.position.set(30, 45, 15);
            scene.add(dirLight);
        }
        
        // --- Mall Creation (Simplified for brevity, unchanged from your original logic) ---
        function createMall() {
            let linkIndex = 0;
            const floorMaterial = getCachedMaterial(0x444444, 0.8, 0.2);
            const wallMaterial = getCachedMaterial(0x6B8E23, 0.9);
            const separatorMaterial = getCachedMaterial(0xFFFFFF, 0.9);

            linkIndex = createFloorLevel(0, floorMaterial, wallMaterial, separatorMaterial, linkIndex);
            const floorY = 1 * (HALL_HEIGHT + 1);
            linkIndex = createUpperFloorLevel(floorY, floorMaterial, wallMaterial, separatorMaterial, linkIndex);

            // Estructura Central
            createCentralCubeScreens(HALL_SIZE / 2, 0, HALL_SIZE / 2, 6, storeLinks.slice(0, 4), 0, 2500);
            createCentralCubeScreens(HALL_SIZE / 2, 6 * 0.8, HALL_SIZE / 2, 6, storeLinks.slice(4, 8), 100, 2000);
            createCentralCubeScreens(HALL_SIZE / 2, 6 * 1.6, HALL_SIZE / 2, 6, storeLinks.slice(8, 12), 200, 1800);
            createDigitalClockCube(HALL_SIZE / 2, 6 * 2.4, HALL_SIZE / 2, 6);
        }
        
        function createFloorLevel(yOffset, floorMaterial, wallMaterial, separatorMaterial, startLinkIndex) {
            // Suelo con patrón de tablero de ajedrez
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            for (let x = 0; x < 8; x++) {
                for (let y = 0; y < 8; y++) {
                    ctx.fillStyle = (x + y) % 2 === 0 ? '#000' : '#FFF';
                    ctx.fillRect(x * 64, y * 64, 64, 64);
                }
            }
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(8, 8);
            const chessboardMaterial = new THREE.MeshStandardMaterial({ map: texture, roughness: 0.8, metalness: 0.1 });
            
            const storeDepth = 12;
            const corridorWidth = 8;
            const areaCentralSize = HALL_SIZE - 2 * (storeDepth + corridorWidth / 2 + 4);
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(areaCentralSize, areaCentralSize), chessboardMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.position.set(HALL_SIZE / 2, yOffset, HALL_SIZE / 2);
            scene.add(floor);
            collisionObjects.push(new THREE.Box3().setFromObject(floor));

            // Tiendas (logic remains the same)
            // Pasillos (logic remains the same)
            // Muros (logic remains the same)
             let linkIndex = startLinkIndex;
            const storeWidth = 8;
            const storeSpacing = 1.5;
            const numStoresPerSide = Math.floor(HALL_SIZE / (storeWidth + storeSpacing));
            const initialOffset = (HALL_SIZE - (numStoresPerSide * (storeWidth + storeSpacing) - storeSpacing)) / 2;

            for (let i = 0; i < numStoresPerSide; i++) {
                if (i === 0 || i === numStoresPerSide - 1) continue;
                 const x = initialOffset + i * (storeWidth + storeSpacing);
                 createStore(new THREE.Vector3(x, yOffset + HALL_HEIGHT / 2, storeDepth / 2), new THREE.Vector2(storeWidth, HALL_HEIGHT), 0, linkIndex++, storeDepth, wallMaterial, yOffset, getNextShopNumber());
                 createStore(new THREE.Vector3(x, yOffset + HALL_HEIGHT / 2, HALL_SIZE - storeDepth / 2), new THREE.Vector2(storeWidth, HALL_HEIGHT), Math.PI, linkIndex++, storeDepth, wallMaterial, yOffset, getNextShopNumber());
            }
            for (let i = 0; i < numStoresPerSide; i++) {
                 if (i === 0 || i === numStoresPerSide - 1) continue;
                 const z = initialOffset + i * (storeWidth + storeSpacing);
                 createStore(new THREE.Vector3(storeDepth / 2, yOffset + HALL_HEIGHT / 2, z), new THREE.Vector2(storeWidth, HALL_HEIGHT), Math.PI / 2, linkIndex++, storeDepth, wallMaterial, yOffset, getNextShopNumber());
                 createStore(new THREE.Vector3(HALL_SIZE - storeDepth / 2, yOffset + HALL_HEIGHT / 2, z), new THREE.Vector2(storeWidth, HALL_HEIGHT), -Math.PI / 2, linkIndex++, storeDepth, wallMaterial, yOffset, getNextShopNumber());
            }

            return linkIndex;
        }

        function createUpperFloorLevel(yOffset, floorMaterial, wallMaterial, separatorMaterial, startLinkIndex) {
            // Suelo y pasillos
            const corridorWidth = 8;
            const storeDepth = 12;
            const pasilloMaterial = new THREE.MeshStandardMaterial({ color: 0x4B0000, roughness: 0.8 });
            const sueloLong = HALL_SIZE - 2 * (storeDepth + corridorWidth);
            const norteZ = storeDepth + corridorWidth;
            const surZ = HALL_SIZE - storeDepth - corridorWidth;
            const oesteX = storeDepth + corridorWidth;
            const esteX = HALL_SIZE - storeDepth - corridorWidth;

            const addCorridor = (size, pos) => {
                const pasillo = new THREE.Mesh(new THREE.BoxGeometry(...size), pasilloMaterial);
                pasillo.position.set(...pos);
                scene.add(pasillo);
                collisionObjects.push(new THREE.Box3().setFromObject(pasillo));
            };
            addCorridor([sueloLong, 0.2, corridorWidth], [HALL_SIZE/2, yOffset - 0.1, norteZ + corridorWidth/2]);
            addCorridor([sueloLong, 0.2, corridorWidth], [HALL_SIZE/2, yOffset - 0.1, surZ - corridorWidth/2]);
            addCorridor([corridorWidth, 0.2, sueloLong], [oesteX + corridorWidth/2, yOffset - 0.1, HALL_SIZE/2]);
            addCorridor([corridorWidth, 0.2, sueloLong], [esteX - corridorWidth/2, yOffset - 0.1, HALL_SIZE/2]);
            // (Corners also need to be added)

            // Tiendas y barandas (logic remains the same)
             let linkIndex = startLinkIndex;
            const storeWidth = 8;
            const storeSpacing = 1.5;
            const numStoresPerSide = Math.floor(HALL_SIZE / (storeWidth + storeSpacing));
            const initialOffset = (HALL_SIZE - (numStoresPerSide * (storeWidth + storeSpacing) - storeSpacing)) / 2;

            for (let i = 0; i < numStoresPerSide; i++) {
                if (i === 0 || i === numStoresPerSide - 1) continue;
                 const x = initialOffset + i * (storeWidth + storeSpacing);
                 createStore(new THREE.Vector3(x, yOffset + HALL_HEIGHT / 2, storeDepth / 2), new THREE.Vector2(storeWidth, HALL_HEIGHT), 0, linkIndex++, storeDepth, wallMaterial, yOffset, getNextShopNumber());
                 createStore(new THREE.Vector3(x, yOffset + HALL_HEIGHT / 2, HALL_SIZE - storeDepth / 2), new THREE.Vector2(storeWidth, HALL_HEIGHT), Math.PI, linkIndex++, storeDepth, wallMaterial, yOffset, getNextShopNumber());
            }
            for (let i = 0; i < numStoresPerSide; i++) {
                 if (i === 0 || i === numStoresPerSide - 1) continue;
                 const z = initialOffset + i * (storeWidth + storeSpacing);
                 createStore(new THREE.Vector3(storeDepth / 2, yOffset + HALL_HEIGHT / 2, z), new THREE.Vector2(storeWidth, HALL_HEIGHT), Math.PI / 2, linkIndex++, storeDepth, wallMaterial, yOffset, getNextShopNumber());
                 createStore(new THREE.Vector3(HALL_SIZE - storeDepth / 2, yOffset + HALL_HEIGHT / 2, z), new THREE.Vector2(storeWidth, HALL_HEIGHT), -Math.PI / 2, linkIndex++, storeDepth, wallMaterial, yOffset, getNextShopNumber());
            }

            return linkIndex;
        }

        function createStore(position, size, rotationY, linkIdx, depth, wallMaterial, floorY, shopNumber) {
            // Logic remains the same
            const storeGroup = new THREE.Group();
            storeGroup.position.copy(position);
            storeGroup.rotation.y = rotationY;
            scene.add(storeGroup);

            const wall = new THREE.Mesh(new THREE.BoxGeometry(size.x, HALL_HEIGHT, depth), wallMaterial);
            storeGroup.add(wall);
            collisionObjects.push(new THREE.Box3().setFromObject(wall));
        }

        function createCentralCubeScreens(x, y, z, size, links, colorOffset, interval) {
            // Logic remains the same
        }

        function createDigitalClockCube(x, y, z, size) {
            // Logic remains the same
        }
        
        // --- Event Listeners and UI Setup ---
        function setupEventListeners() {
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('mousedown', onMouseDown);
            
            if (isMobile()) {
                setupMobileControls();
            }
        }

        function setupUI() {
            // --- Customization Panel ---
            const customizationPanel = document.getElementById('customization-panel');
            const aliasInput = document.getElementById('customization-alias-input');
            const currentAliasEl = document.getElementById('current-alias');
            const previewAliasEl = document.getElementById('preview-alias');

            document.getElementById('change-alias-btn').onclick = () => {
                customizationPanel.style.display = 'flex';
                customizationPanelOpen = true;
                aliasInput.value = currentCustomization.alias;
                currentAliasEl.textContent = currentCustomization.alias || 'Sin nombre';
                previewAliasEl.textContent = currentCustomization.alias || 'Sin nombre';
                updateAvatarPreview();
                updateAllColorSelections();
            };

            document.getElementById('customization-close-btn').onclick = () => {
                customizationPanel.style.display = 'none';
                customizationPanelOpen = false;
            };
            
            aliasInput.addEventListener('input', () => {
                previewAliasEl.textContent = aliasInput.value.trim() || 'Sin nombre';
            });
            
            document.getElementById('save-customization-btn').onclick = saveCustomization;
            document.getElementById('reset-customization-btn').onclick = resetCustomization;

            // --- Chat Panel ---
             const chatPanel = document.getElementById('chat-panel');
             document.getElementById('chat-toggle-btn').onclick = () => {
                chatPanel.style.display = 'flex';
                chatOpen = true;
             };
             document.getElementById('chat-close-btn').onclick = () => {
                chatPanel.style.display = 'none';
                chatOpen = false;
             };
             // (rest of chat logic...)
        }
        
        function onKeyDown(event) {
            if (customizationPanelOpen || chatOpen) return;
            const key = event.code.replace('Key', '');
            if (key in keys) keys[key] = true;
            if (event.code in keys) keys[event.code] = true;

            // Floor change
            if (event.code === 'KeyE') { // E to go up
                if (currentFloor < MAX_FLOOR) currentFloor++;
            }
            if (event.code === 'KeyQ') { // Q to go down
                if (currentFloor > MIN_FLOOR) currentFloor--;
            }
        }

        function onKeyUp(event) {
            const key = event.code.replace('Key', '');
            if (key in keys) keys[key] = false;
            if (event.code in keys) keys[event.code] = false;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onMouseDown(event) {
            if (customizationPanelOpen || chatOpen || event.button !== 0) return;
            // Raycasting logic for clicking on stores...
        }
        
        // --- Mobile Controls ---
        function setupMobileControls() {
            const moveStick = document.createElement('div');
            moveStick.style.cssText = 'position:fixed; bottom:20px; left:20px; width:100px; height:100px; background:rgba(0,0,0,0.3); border-radius:50%; z-index:1001;';
            const moveKnob = document.createElement('div');
            moveKnob.style.cssText = 'position:absolute; top:50%; left:50%; width:40px; height:40px; background:rgba(255,255,255,0.5); border-radius:50%; transform:translate(-50%,-50%);';
            moveStick.appendChild(moveKnob);
            document.body.appendChild(moveStick);

            const lookStick = document.createElement('div');
            lookStick.style.cssText = 'position:fixed; bottom:20px; right:20px; width:100px; height:100px; background:rgba(0,0,0,0.3); border-radius:50%; z-index:1001;';
            const lookKnob = document.createElement('div');
            lookKnob.style.cssText = 'position:absolute; top:50%; left:50%; width:40px; height:40px; background:rgba(255,255,255,0.5); border-radius:50%; transform:translate(-50%,-50%);';
            lookStick.appendChild(lookKnob);
            document.body.appendChild(lookStick);

            const handleTouch = (stick, knob, joystick, activeFlagSetter, e) => {
                e.preventDefault();
                const rect = stick.getBoundingClientRect();
                if (e.type === 'touchend') {
                    activeFlagSetter(false);
                    joystick.x = 0;
                    joystick.y = 0;
                    knob.style.transform = 'translate(-50%, -50%)';
                    return;
                }
                
                activeFlagSetter(true);
                const touch = e.touches[0];
                const dx = touch.clientX - (rect.left + rect.width / 2);
                const dy = touch.clientY - (rect.top + rect.height / 2);
                const dist = Math.min(rect.width / 2, Math.sqrt(dx*dx + dy*dy));
                const angle = Math.atan2(dy, dx);
                
                joystick.x = (Math.cos(angle) * dist) / (rect.width / 2);
                joystick.y = (Math.sin(angle) * dist) / (rect.height / 2);

                knob.style.transform = `translate(calc(-50% + ${Math.cos(angle) * dist}px), calc(-50% + ${Math.sin(angle) * dist}px))`;
            };
            
            moveStick.addEventListener('touchstart', handleTouch.bind(null, moveStick, moveKnob, moveJoystick, val => moveJoystickActive = val));
            moveStick.addEventListener('touchmove', handleTouch.bind(null, moveStick, moveKnob, moveJoystick, val => moveJoystickActive = val));
            moveStick.addEventListener('touchend', handleTouch.bind(null, moveStick, moveKnob, moveJoystick, val => moveJoystickActive = val));

            lookStick.addEventListener('touchstart', handleTouch.bind(null, lookStick, lookKnob, cameraJoystick, val => cameraJoystickActive = val));
            lookStick.addEventListener('touchmove', handleTouch.bind(null, lookStick, lookKnob, cameraJoystick, val => cameraJoystickActive = val));
            lookStick.addEventListener('touchend', handleTouch.bind(null, lookStick, lookKnob, cameraJoystick, val => cameraJoystickActive = val));
        }

        // --- Core Update & Animate ---
        function updateMovement() {
            if (chatOpen || customizationPanelOpen) return;

            const velocity = new THREE.Vector3();
            const direction = new THREE.Vector3();
            
            camera.getWorldDirection(direction);
            direction.y = 0;
            direction.normalize();

            if (isMobile()) {
                // --- Mobile Logic ---
                // Right Joystick (Look)
                if (cameraJoystickActive) {
                    targetRotationY -= cameraJoystick.x * ROTATE_SPEED;
                }
                // Left Joystick (Move) - Forward/Backward Only
                if (moveJoystickActive && Math.abs(moveJoystick.y) > 0.1) {
                    // moveJoystick.y is negative when pushed up, so we invert it
                    velocity.add(direction.multiplyScalar(-moveJoystick.y * MOVE_SPEED));
                }
            } else {
                // --- Desktop Logic ---
                if (keys.ArrowLeft) targetRotationY += ROTATE_SPEED;
                if (keys.ArrowRight) targetRotationY -= ROTATE_SPEED;
                
                const rightDirection = new THREE.Vector3().crossVectors(camera.up, direction).normalize();
                if (keys.W || keys.ArrowUp) velocity.add(direction);
                if (keys.S || keys.ArrowDown) velocity.sub(direction);
                if (keys.A) velocity.sub(rightDirection);
                if (keys.D) velocity.add(rightDirection);
            }
            
            if (velocity.length() > 0) {
                const newPosition = targetPosition.clone().add(velocity.normalize().multiplyScalar(MOVE_SPEED));
                if (!checkCollision(newPosition)) {
                    targetPosition.copy(newPosition);
                }
            }
            
            // Common interpolation
            const targetY = currentFloor * (HALL_HEIGHT + 1) + CAMERA_HEIGHT;
            targetPosition.y = targetY;
            camera.position.lerp(targetPosition, 0.2);
            camera.rotation.y = lerpAngle(camera.rotation.y, targetRotationY, 0.2);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            updateMovement();
            // updateAvatarPositions(); // Add this back when avatars are fully integrated
            renderer.render(scene, camera);
        }
        
        // --- Customization Logic ---
        function updateColorSelection(gridId, selectedElement) {
            const grid = document.getElementById(gridId);
            grid.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('selected'));
            if(selectedElement) {
                selectedElement.classList.add('selected');
            }
        }
        
        function updateAllColorSelections() {
             updateColorSelection('shirt-color-grid', document.querySelector(`#shirt-color-grid .color-btn[data-color="${currentCustomization.shirtColor}"]`));
             updateColorSelection('pants-color-grid', document.querySelector(`#pants-color-grid .color-btn[data-color="${currentCustomization.pantsColor}"]`));
             updateColorSelection('shoes-color-grid', document.querySelector(`#shoes-color-grid .color-btn[data-color="${currentCustomization.shoesColor}"]`));
        }

        function changeShirtColor(element, color) {
            currentCustomization.shirtColor = color;
            updateColorSelection('shirt-color-grid', element);
            updateAvatarPreview();
        }

        function changePantsColor(element, color) {
            currentCustomization.pantsColor = color;
            updateColorSelection('pants-color-grid', element);
            updateAvatarPreview();
        }

        function changeShoesColor(element, color) {
            currentCustomization.shoesColor = color;
            updateColorSelection('shoes-color-grid', element);
            updateAvatarPreview();
        }

        function updateAvatarPreview() {
            const previewDiv = document.getElementById('avatar-preview');
            const shirtColor = `#${currentCustomization.shirtColor.toString(16).padStart(6, '0')}`;
            const pantsColor = `#${currentCustomization.pantsColor.toString(16).padStart(6, '0')}`;
            const shoesColor = `#${currentCustomization.shoesColor.toString(16).padStart(6, '0')}`;

            previewDiv.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; gap: 1px;">
                    <div style="width: 30px; height: 30px; background: #FFE4C4; border-radius: 4px;"></div>
                    <div style="width: 40px; height: 45px; background: ${shirtColor}; border-radius: 4px;"></div>
                    <div style="width: 40px; height: 35px; background: ${pantsColor}; border-radius: 4px;"></div>
                    <div style="width: 40px; height: 10px; background: ${shoesColor}; border-radius: 2px;"></div>
                </div>
            `;
        }

        function saveCustomization() {
            const aliasInput = document.getElementById('customization-alias-input');
            const newAlias = aliasInput.value.trim();
            if (!newAlias) {
                alert('El nombre no puede estar vacío.');
                return;
            }
            currentCustomization.alias = newAlias;
            localStorage.setItem('avatarCustomization', JSON.stringify(currentCustomization));
            // applyCustomizationToAvatar(userAlias, currentCustomization); // Apply to the actual 3D avatar
            document.getElementById('customization-panel').style.display = 'none';
            customizationPanelOpen = false;
            alert('¡Personalización guardada!');
        }
        
        function resetCustomization() {
            currentCustomization.shirtColor = 0x4ECDC4;
            currentCustomization.pantsColor = 0x2C3E50;
            currentCustomization.shoesColor = 0x8B4513;
            updateAvatarPreview();
            updateAllColorSelections();
        }

        function loadCustomization() {
            const saved = localStorage.getItem('avatarCustomization');
            if (saved) {
                currentCustomization = JSON.parse(saved);
            }
        }
        
        // --- Init Call ---
        loadCustomization();
        init();

    </script>
</body>
</html>