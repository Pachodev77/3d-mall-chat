<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paseo Virtual por Centro Comercial</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #000;
        }
        
        /* Estilos para los controles m√≥viles */
        .mobile-controls {
            position: fixed;
            bottom: 20px;
            width: 100%;
            height: 120px;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 30001;
        }
        
        .control-pad {
            width: 120px;
            height: 120px;
            background: rgba(30,30,30,0.8);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        
        .control-button {
            width: 50px;
            height: 50px;
            background: #444;
            border-radius: 50%;
            border: 2px solid #666;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .control-button:hover {
            background: #666;
        }
        
        .control-button:active {
            background: #888;
        }
        
        .control-button i {
            font-size: 24px;
        }
        canvas {
            display: block;
        }
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background-color: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            mix-blend-mode: difference;
            z-index: 10;
            pointer-events: none;
        }
        #chat-toggle-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            width: 36px;
            height: 36px;
            background: #222;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 22000;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 20px;
            transition: background 0.2s;
        }
        #chat-toggle-btn:hover {
            background: #444;
        }
        #chat-panel {
            position: fixed;
            top: 60px;
            left: 16px;
            width: 480px;
            max-width: 90vw;
            height: 600px;
            background: rgba(30,30,30,0.85);
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.4);
            z-index: 31000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
            pointer-events: auto;
        }
        #chat-header {
            background: rgba(24,24,24,0.9);
            color: #fff;
            padding: 12px 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        #chat-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        #chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        #users-sidebar {
            width: 140px;
            background: rgba(34,34,34,0.9);
            border-left: 1px solid #333;
            padding: 8px;
            overflow-y: auto;
        }
        #users-title {
            color: #aaa;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
        }
        .user-item {
            color: #fff;
            font-size: 12px;
            padding: 4px 6px;
            margin-bottom: 2px;
            border-radius: 4px;
            background: #333;
            border-left: 3px solid transparent;
        }
        #emoji-panel {
            position: absolute;
            bottom: 70px;
            left: 10px;
            right: 10px;
            background: rgba(51,51,51,0.95);
            border-radius: 8px;
            padding: 10px;
            display: none;
            flex-wrap: wrap;
            gap: 4px;
            max-height: 140px;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }
        .emoji-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .emoji-btn:hover {
            background: #555;
        }
        #emoji-toggle {
            background: none;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            margin-right: 4px;
        }
        #chat-close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }
        #chat-messages {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            color: #eee;
            font-size: 15px;
        }
        #chat-input-area {
            display: flex;
            border-top: 1px solid #333;
            background: rgba(34,34,34,0.9);
            padding: 10px;
        }
        #chat-input {
            flex: 1;
            border: none;
            background: #333;
            color: #fff;
            border-radius: 6px;
            padding: 8px;
            font-size: 15px;
        }
        #chat-send-btn {
            background: #4B0000;
            color: #fff;
            border: none;
            border-radius: 6px;
            margin-left: 8px;
            padding: 8px 14px;
            font-size: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        #chat-send-btn:hover {
            background: #800000;
        }
        #alias-prompt {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1002;
        }
        #alias-prompt input {
            padding: 10px;
            font-size: 16px;
            border-radius: 6px;
            border: none;
            margin-bottom: 12px;
        }
        #alias-prompt button {
            padding: 8px 18px;
            font-size: 15px;
            border-radius: 6px;
            border: none;
            background: #4B0000;
            color: #fff;
            cursor: pointer;
        }
        #change-alias-btn {
            position: fixed;
            top: 16px;
            left: 60px;
            width: 36px;
            height: 36px;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 22000;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 16px;
            transition: background 0.2s;
        }
        #change-alias-btn:hover {
            background: #555;
        }
        
        /* Estilos para el panel de personalizaci√≥n simple */
        #simple-panel.customization-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1100px;
            max-width: 99vw;
            height: 700px;
            background: linear-gradient(135deg, rgba(20,20,20,0.98), rgba(30,30,30,0.98));
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            z-index: 31000; /* Siempre por encima del overlay */
            display: none;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 2px solid #4B0000;
            pointer-events: auto;
        }
        
        #simple-panel .panel-header {
            background: linear-gradient(135deg, #4B0000, #800000);
            color: #fff;
            padding: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #FFD700;
        }
        
        #simple-panel .panel-header > div {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        #simple-panel .panel-header > div span:first-child {
            font-size: 28px;
        }
        
        #simple-panel .panel-header > div span:last-child {
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        #simple-panel .panel-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            color: #eee;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            min-height: 0;
            min-width: 0;
        }
        
        #simple-panel .options-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        #simple-panel .preview-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        #simple-panel .option-section {
            padding: 8px;
            background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(50,50,50,0.8));
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            margin-bottom: 4px;
        }
        
        #simple-panel .section-title {
            margin: 0 0 8px 0;
            color: #FFD700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        #simple-panel .section-title span:first-child {
            font-size: 16px;
        }
        
        #simple-panel .color-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
        }
        
        #simple-panel .preview-section {
            padding: 10px;
            background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(50,50,50,0.8));
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        #simple-panel .avatar-preview {
            width: 150px;
            height: 200px;
            margin: 0 auto;
            position: relative;
            background: linear-gradient(135deg, rgba(20,20,20,0.5), rgba(30,30,30,0.5));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #333;
        }
        
        #simple-panel .panel-footer {
            padding: 8px 10px;
            background: linear-gradient(135deg, rgba(34,34,34,0.95), rgba(44,44,44,0.95));
            border-top: 1px solid #333;
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }
        
        /* Estilos adicionales para elementos espec√≠ficos */
        #simple-panel .close-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.3s;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #simple-panel .section-icon {
            font-size: 16px;
        }

        #simple-panel #simple-alias-input {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            border-radius: 6px;
            border: 2px solid #333;
            background: rgba(20,20,20,0.8);
            color: #fff;
            box-sizing: border-box;
            transition: all 0.3s;
            outline: none;
        }

        #simple-panel #simple-alias-input:focus {
            border-color: #FFD700;
        }

        #customization-actions {
            padding: 16px 20px;
            background: rgba(34,34,34,0.9);
            border-top: 1px solid #333;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            width: 100%;
            min-height: 60px;
            box-sizing: border-box;
        }
        
        .customization-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #save-customization-btn {
            background: linear-gradient(135deg, #4B0000, #800000);
            color: #fff;
        }
        
        #save-customization-btn:hover {
            background: linear-gradient(135deg, #800000, #B22222);
            transform: translateY(-1px);
        }
        
        #reset-customization-btn {
            background: #333;
            color: #ccc;
        }
        
        #reset-customization-btn:hover {
            background: #555;
            color: #fff;
        }
        
        /* Estilos para los botones de color */
        .color-option {
            width: 30px;
            height: 30px;
            border: 2px solid #333;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--color, #333);
        }
        .color-option[data-color] {
            border: 2px solid #333;
        }
        .color-option:hover {
            border-color: #FFD700;
        }
        
        /* Animaciones para el panel */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
        
        #simple-panel {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Estilos para el input de alias */
        #simple-alias-input:focus {
            border-color: #FFD700 !important;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3) !important;
        }
        
        /* Estilos para los botones del footer */
        #simple-panel button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4) !important;
        }
        
        #simple-panel button:active {
            transform: translateY(0);
        }
        .chat-message {
            padding: 6px 10px;
            border-radius: 8px;
            margin-bottom: 4px;
            background: rgba(40,40,40,0.7);
            display: inline-block;
            max-width: 90%;
            word-break: break-word;
        }
        .chat-message.own {
            background: linear-gradient(90deg, #FFD70033, #FFD70011);
        }
        /* Overlay para bloquear clics al fondo cuando el panel de personalizaci√≥n est√° abierto */
        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            z-index: 20000; /* Debe estar debajo del panel de personalizaci√≥n */
            pointer-events: none; /* Solo se activa cuando el panel est√° abierto */
            display: none; /* Solo se muestra cuando el panel est√° abierto */
        }
        /* Panel de personalizaci√≥n siempre por encima del overlay */
        #simple-panel.customization-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1100px;
            max-width: 99vw;
            height: 700px;
            background: linear-gradient(135deg, rgba(20,20,20,0.98), rgba(30,30,30,0.98));
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            z-index: 31000; /* Siempre por encima del overlay */
            display: none;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 2px solid #4B0000;
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <!-- Contenedor de UI completamente separado del canvas -->
    <div id="ui-container" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 30000;">
        <div id="ui-overlay"></div>
    <div id="crosshair"></div>
        <button id="chat-toggle-btn" title="Abrir chat" style="pointer-events: auto;">üí¨</button>
        <button id="change-alias-btn" title="Personalizar avatar" style="pointer-events: auto;">üë§</button>
    </div>
        <!-- Panel de personalizaci√≥n completamente redise√±ado -->
    <div id="simple-panel" class="customization-panel">
        <!-- Header elegante -->
        <div class="panel-header">
            <div>
                <span>üë§</span>
                <span>Personalizar Avatar</span>
            </div>
            <button onclick="closeSimplePanel()" class="close-btn">‚úñ</button>
        </div>
        
        <!-- Contenido principal -->
        <div class="panel-content">
            <!-- Columna izquierda - Opciones -->
            <div class="options-column">
                <!-- Secci√≥n de Alias -->
                <div class="option-section">
                    <h3 class="section-title">
                        <span class="section-icon">üìù</span>
                        Nombre del Avatar
                    </h3>
                    <input type="text" id="simple-alias-input" placeholder="Escribe tu nombre..." maxlength="20">
                </div>
                
                <!-- Secci√≥n de Colores de Camisa -->
                <div class="option-section">
                    <h3 class="section-title">
                        <span class="section-icon">üëï</span>
                        Color de Camisa
                    </h3>
                    <div id="shirt-colors" class="color-grid">
                        <!-- Los colores se agregar√°n din√°micamente -->
                    </div>
                </div>
                
                <!-- Secci√≥n de Colores de Pantal√≥n -->
                <div class="option-section">
                    <h3 class="section-title">
                        <span style="font-size: 20px;">üëñ</span>
                        Color de Pantal√≥n
                    </h3>
                    <div id="pants-colors" class="color-grid">
                        <!-- Los colores se agregar√°n din√°micamente -->
                    </div>
                </div>
                
                <!-- Secci√≥n de Colores de Zapatos -->
                <div class="option-section">
                    <h3 class="section-title">
                        <span style="font-size: 20px;">üëû</span>
                        Color de Zapatos
                    </h3>
                    <div id="shoes-colors" class="color-grid">
                        <!-- Los colores se agregar√°n din√°micamente -->
                    </div>
                </div>
            </div>
            
            <!-- Columna derecha - Vista previa -->
            <div class="preview-column">
                <!-- Vista previa del avatar -->
                <div class="preview-section">
                    <h3 style="margin: 0 0 20px 0; color: #FFD700; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 20px;">üë§</span>
                        Vista Previa
                    </h3>
                    <div id="avatar-preview" class="avatar-preview">
                        <div style="color: #ccc; font-size: 14px;">Avatar en tiempo real</div>
                    </div>
                </div>
                <!-- Eliminada la tarjeta de 'Nombre Actual' y alias -->
            </div>
        </div>
        
        <!-- Footer con botones -->
        <div class="panel-footer">
            <button onclick="resetSimpleCustomization()" style="padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; background: linear-gradient(135deg, #555, #777); color: #fff; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">üîÑ Restablecer</button>
            <button onclick="saveSimpleCustomization()" style="padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; background: linear-gradient(135deg, #4B0000, #800000); color: #fff; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">üíæ Guardar</button>
        </div>
    </div>
    <!-- Controles m√≥viles -->
    <div class="mobile-controls">
        <div class="control-pad">
            <div class="control-button" id="forward" title="Adelante">‚Üë</div>
            <div class="control-button" id="backward" title="Atr√°s">‚Üì</div>
        </div>
        <div class="control-pad">
            <div class="control-button" id="left" title="Izquierda">‚Üê</div>
            <div class="control-button" id="right" title="Derecha">‚Üí</div>
        </div>
    </div>

    <div id="chat-panel">
        <div id="chat-header">
            Chat
            <button id="chat-close-btn" title="Cerrar">‚úñ</button>
        </div>
        <div id="chat-content">
            <div id="chat-main">
                <div id="chat-messages"></div>
                <div id="chat-input-area">
                    <button id="emoji-toggle" title="Emojis">üòä</button>
                    <input id="chat-input" type="text" placeholder="Escribe un mensaje..." autocomplete="off" />
                    <button id="chat-send-btn">Enviar</button>
                </div>
                <div id="emoji-panel"></div>
            </div>
            <div id="users-sidebar">
                <div id="users-title">Usuarios</div>
                <div id="users-list"></div>
            </div>
        </div>
    </div>
    
    <!-- Panel de personalizaci√≥n de avatar -->
    <!-- Eliminado: <div id="customization-panel">...</div> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="/firebase-config.js"></script>
    <script>
        // URLs de las tiendas proporcionadas por el usuario (duplicadas para llenar todos los pisos)
        const originalStoreLinks = [
            "https://www.ipweb.pro/en/?Davincho88", "https://ipgold.biz/?r=meramente42@gmail.com", "https://surfe.be/ext/2837287",
            "https://sproutgigs.com/?a=0675642e", "https://r.adbtc.top/2847448", "https://www.coinpayu.com/?r=everest101",
            "https://surfio.site/i/794", "https://serfclick.net/i/277142", "https://faucetcrypto.com/r/1373767",
            "https://earnbitmoon.club/?ref=1075373", "https://viefaucet.com?r=6383ddeaec6d7776fc69e555", "https://simplebits.io/ref/OLkiv6stfLj_",
            "https://tap-coin.de/refer/user/4365", "https://btcadspace.com/ref/p4ch3c0", "https://trustdice.win/faucet/?ref=u_mapachox101",
            "http://cointiply.com/r/4yDJAp", "https://autofaucet.dutchycorp.space/?r=sakreto", "https://freebitco.in/?r=49843181",
            "https://faucetpay.io/?r=2136351", "https://r.honeygain.me/MERAM588A9", "https://pawns.app/?r=585883",
            "https://teaserfast.ru/u/mapachox", "https://addon.money/p/343495", "https://everve.net/ref/961754/",
            "https://swashapp.io/download?referral_code=3opl7k4ztf53", "https://addslice.com/?crew=JHVJ6", "https://earnapp.com/i/4zbftm2",
            "https://node.optimai.network/register?ref=F471454F", "https://dashboard.teneo.pro/auth/signup?referralCode=ERPr2", "https://app.nodepay.ai/register?ref=kOYHwfDuFNSSZg2",
            "https://www.jumptask.io/r/budapygirazu", "https://payeer.com/?partner=23994523", "https://rollercoin.com/?r=m9dnpgsp",
            "https://bux.money/u/239006", "https://www.swagbucks.com/p/register?rb=119244201&rp=1", "https://app.getgrass.io/register?referralCode=SwWRadefuICY8DI",
            "https://freecash.com/r/116249823271721789104", "https://r.honeygain.me/AIRRIFADB7", "https://www.binance.com/referral/earn-together/refertoearn2000usdc/claim?hl=en&ref=GRO_14352_ZBFKF",
            "https://www.paidwork.com/?r=meramente42", "https://www.bybit.com/invite?ref=VWN6NL", "https://app-earnings-link.com/givvyMusic/hoty216dfkvisgv",
            "https://swcapp.com/i/davehz", "https://app-earnings-link.com/givvyStream/a6dd8fsmn6t6qhfjjw5", "https://app-earnings-link.com/givvyScratchCardNew/euz9t4x3bmk6"
        ];

        // Mapeo de dominios a nombres de archivo de logos
        const domainToLogoMap = {
            'ipweb': 'ipweb-logo.png',
            'ipgold': 'ipgold-logo.png',
            'surfe': 'surfe-logo.png',
            'sproutgigs': 'sproutgigs-logo.png',
            'adbtc': 'adbtc-logo.png',
            'coinpayu': 'coinpayu-logo.png',
            'surfio': 'surfio-logo.png',
            'serfclick': 'serfclick-logo.png',
            'faucetcrypto': 'faucetcrypto-logo.png',
            'earnbitmoon': 'earnbitmoon-logo.png',
            'viefaucet': 'viefaucet-logo.png',
            'simplebits': 'simplebits-logo.png',
            'tap-coin': 'tapcoin-logo.png',
            'btcadspace': 'btcadspace-logo.png',
            'trustdice': 'trustdice-logo.png',
            'cointiply': 'cointiply-logo.png',
            'autofaucet': 'autofaucet-logo.png',
            'freebitco': 'freebitcoin-logo.png',
            'faucetpay': 'faucetpay-logo.png',
            'honeygain': 'honeygain-logo.png',
            'pawns': 'pawns-logo.png',
            'teaserfast': 'teaserfast-logo.png',
            'addon': 'addonmoney-logo.png',
            'everve': 'everve-logo.png',
            'swashapp': 'swash-logo.png',
            'addslice': 'addslice-logo.png',
            'earnapp': 'earnapp-logo.png',
            'optimai': 'optimai-logo.png',
            'teneo': 'teneo-logo.png',
            'nodepay': 'nodepay-logo.png',
            'jumptask': 'jumptask-logo.png',
            'payeer': 'payeer-logo.png',
            'rollercoin': 'rollercoin-logo.png',
            'bux': 'buxmoney-logo.png',
            'swagbucks': 'swagbucks-logo.png',
            'grass': 'grass-logo.png',
            'getgrass': 'grass-logo.png', // Agregar alias para app.getgrass.io
            'freecash': 'freecash-logo.png',
            'binance': 'binance-logo.png',
            'paidwork': 'paidwork-logo.png',
            'bybit': 'bybit-logo.png',
            'givvyMusic': 'givvymusic-logo.png',
            'givvyStream': 'givvystream-logo.png',
            'givvyScratchCardNew': 'givvystream-logo.png', // Usar givvystream como fallback
            'swcapp': 'swcapp-logo.png',
            'app-earnings-link': 'givvystream-logo.png' // Agregar alias para app-earnings-link.com
        };

        // Duplicar los enlaces 5 veces para asegurar que hay suficientes para todos los pisos
        const storeLinks = [];
        for (let i = 0; i < 5; i++) {
            storeLinks.push(...originalStoreLinks);
        }

        // --- Constantes y Configuraci√≥n Global ---
        const HALL_SIZE = 90; // Aumentado 1.5 veces (60 * 1.5 = 90)
        const HALL_HEIGHT = 4;
        const MOVE_SPEED = 0.8;
        const ROTATE_SPEED = 0.1;
        const CAMERA_HEIGHT = 1.6;
        const MAX_FLOOR = 1; // Cambiado de 4 a 1 (solo 2 pisos: planta baja + 1 piso superior)
        const MIN_FLOOR = 0;

        // --- Variables de la Escena ---
        let scene, camera, renderer;
        const clickableObjects = [];
        const collisionObjects = [];
        const keys = { W: false, S: false, A: false, D: false, ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false };
        
        // --- Variables para Avatares de Usuarios ---
        const userAvatars = new Map(); // Mapa de alias -> avatar
        const avatarColors = [
            0xFF6B6B, 0x4ECDC4, 0x45B7D1, 0x96CEB4, 0xFFEAA7,
            0xDDA0DD, 0x98D8C8, 0xF7DC6F, 0xBB8FCE, 0x85C1E9,
            0xF8C471, 0x82E0AA, 0xF1948A, 0x85C1E9, 0xD7BDE2,
            0xF9E79F, 0xABEBC6, 0xFAD7A0, 0xAED6F1, 0xF5B7B1
        ];

        // --- Variables de personalizaci√≥n de avatar ---
        const customizationColors = [
            // Colores vibrantes para camisas
            0xFF6B6B, 0x4ECDC4, 0x45B7D1, 0x96CEB4, 0xFFEAA7, 0xDDA0DD,
            0x98D8C8, 0xF7DC6F, 0xBB8FCE, 0x85C1E9, 0xF8C471, 0x82E0AA,
            0xF1948A, 0xD7BDE2, 0xF9E79F, 0xABEBC6, 0xFAD7A0, 0xAED6F1,
            // Colores m√°s oscuros para pantalones
            0x2C3E50, 0x34495E, 0x8B4513, 0x654321, 0x2F4F4F, 0x696969,
            0x556B2F, 0x8B0000, 0x4B0082, 0x191970, 0x006400, 0x8B4513,
            0x654321, 0x2F4F4F, 0x696969, 0x556B2F, 0x8B0000, 0x4B0082,
            // Colores para zapatos
            0x8B4513, 0x654321, 0x000000, 0x2F4F4F, 0x696969, 0x8B0000,
            0x4B0082, 0x191970, 0x006400, 0x8B4513, 0x654321, 0x2F4F4F,
            0x696969, 0x556B2F, 0x8B0000, 0x4B0082, 0x191970, 0x006400
        ];
        
        let currentCustomization = {
            shirtColor: 0x4ECDC4, // Color por defecto
            pantsColor: 0x2C3E50, // Color por defecto
            shoesColor: 0x8B4513  // Color por defecto
        };
        
        let customizationPanelOpen = false;

        // --- Variables de Interacci√≥n y Movimiento ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let targetPosition;
        let targetRotationY;
        let currentFloor = 0;
        let keyA = false;
        let keyD = false;
        let keyW = false;
        let keyS = false;
        let shopNumberCounter = 1; // Contador global para numerar las tiendas

        // Funci√≥n para obtener el siguiente n√∫mero de tienda solo cuando se crea una
        const getNextShopNumber = () => {
            return shopNumberCounter++;
        };

        // --- Variables de rendimiento ---
        let lastTime = 0;
        let frameCount = 0;
        let fps = 60;
        const targetFPS = 60;
        const frameInterval = 1000 / targetFPS;
        let lastSkyUpdate = 0; // Para actualizar el cielo cada minuto

        // --- Cache de materiales para reutilizaci√≥n ---
        const materialCache = new Map();
        const textureCache = new Map();

        function getCachedMaterial(color, roughness = 0.8, metalness = 0.2) {
            const key = `${color}-${roughness}-${metalness}`;
            if (!materialCache.has(key)) {
                materialCache.set(key, new THREE.MeshStandardMaterial({ 
                    color, 
                    roughness, 
                    metalness 
                }));
            }
            return materialCache.get(key);
        }

        function getCachedTexture(text, colorIdx, width, height) {
            const key = `${text}-${colorIdx}-${width}-${height}`;
            if (!textureCache.has(key)) {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                const canvasW = Math.min(512, width * 64); // Reducir tama√±o del canvas
                const canvasH = Math.min(512, height * 64);
                canvas.width = canvasW;
                canvas.height = canvasH;
                
                context.fillStyle = `hsl(${colorIdx * 47 % 360}, 60%, 50%)`;
                context.fillRect(0, 0, canvasW, canvasH);
                
                context.font = `bold ${canvasH * 0.3}px Arial`;
                context.fillStyle = 'white';
                context.textAlign = 'center';
                context.textBaseline = 'middle';
                context.fillText(text.charAt(0).toUpperCase() + text.slice(1), canvasW / 2, canvasH / 2);

                const texture = new THREE.CanvasTexture(canvas);
                textureCache.set(key, texture);
            }
            return textureCache.get(key);
        }

        // --- Funci√≥n para obtener el color del cielo seg√∫n la hora ---
        function getSkyColor() {
            const now = new Date();
            const hour = now.getHours();
            
            // Transiciones suaves entre colores seg√∫n la hora
            if (hour >= 6 && hour < 12) {
                // Ma√±ana: azul claro
                return new THREE.Color(0x87CEEB); // Sky blue
            } else if (hour >= 12 && hour < 18) {
                // Tarde: azul m√°s intenso
                return new THREE.Color(0x4682B4); // Steel blue
            } else if (hour >= 18 && hour < 20) {
                // Atardecer: naranja/rosa
                return new THREE.Color(0xFF7F50); // Coral
            } else if (hour >= 20 && hour < 22) {
                // Anochecer: azul oscuro
                return new THREE.Color(0x191970); // Midnight blue
            } else {
                // Noche: negro
                return new THREE.Color(0x000000); // Black
            }
        }

        function init() {
}
            scene.fog = new THREE.Fog(0x1a1a1a, 15, 105); // Ajustado para el nuevo tama√±o

// --- Manejadores de Eventos ---
function setupEventListeners() {
    document.addEventListener('keydown', onKeyDown);
    document.addEventListener('keyup', onKeyUp);
    window.addEventListener('resize', onWindowResize);
    document.addEventListener('mousedown', onMouseDown);
}

// --- Manejadores de controles m√≥viles ---
function setupMobileControls() {
    const forward = document.getElementById('forward');
    const backward = document.getElementById('backward');
    const left = document.getElementById('left');
    const right = document.getElementById('right');

    // Eventos para adelante
    forward.addEventListener('touchstart', () => {
        moveForward = true;
    });
    forward.addEventListener('touchend', () => {
        moveForward = false;
    });
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function onMouseDown(event) {
            // CR√çTICO: Verificar si el clic es en un elemento de UI - NO procesar en ese caso
            const target = event.target;
            const isUIElement = target.closest('#ui-container') || 
                               target.closest('#chat-panel') || 
                               target.closest('#simple-panel') ||
                               target.closest('#ui-overlay') ||
                               target.closest('button') ||
                               target.closest('input') ||
                               target.closest('select');
            
            if (isUIElement) {
                return; // NO procesar clics en elementos de UI
            }
            
            // Si el overlay est√° activo, no procesar ning√∫n clic del juego
            const overlay = document.getElementById('ui-overlay');
            if (overlay && overlay.style.display === 'block' && overlay.style.pointerEvents === 'auto') {
                return;
            }
            // Si el chat est√° abierto, no procesar controles del juego
            if (chatOpen) {
                return;
            }
            // Si el panel de personalizaci√≥n est√° abierto, no procesar clics del juego
            const simplePanel = document.getElementById('simple-panel');
            if (simplePanel && simplePanel.style.display === 'block') {
                return;
            }
            
            if (event.button !== 0) return; // Solo clic izquierdo
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(clickableObjects);
            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;
                
                // Verificar si es un clic en el nombre del avatar para personalizaci√≥n
                if (clickedObject.userData && clickedObject.userData.type === 'customization') {
                    openCustomizationPanel();
                    return;
                }
                
                // Verificar si es un clic en una tienda
                if (clickedObject.userData.URL) {
                    window.open(clickedObject.userData.URL, '_blank');
                }
            }
        }

        function updateMovement() {
            // Si el chat est√° abierto, no actualizar movimiento
            if (chatOpen) {
                return;
            }
            
            // --- Rotaci√≥n con flechas izquierda/derecha ---
            if (keys.ArrowLeft) targetRotationY -= ROTATE_SPEED;
            if (keys.ArrowRight) targetRotationY += ROTATE_SPEED;

            // --- Movimiento hacia adelante/atr√°s con flechas ---
            const direction = new THREE.Vector3();
            camera.getWorldDirection(direction);
            direction.y = 0;
            direction.normalize();
            
            const velocity = new THREE.Vector3();
            
            // Movimiento hacia adelante/atr√°s con flechas arriba/abajo
            if (keys.ArrowUp) velocity.add(direction);
            if (keys.ArrowDown) velocity.sub(direction);
            
            // Movimiento lateral con A y D (teclas)
            const rightDirection = new THREE.Vector3();
            rightDirection.setFromMatrixColumn(camera.matrix, 0);
            rightDirection.y = 0;
            rightDirection.normalize();
            
            if (keyA) velocity.sub(rightDirection); // Moverse hacia la izquierda
            if (keyD) velocity.add(rightDirection); // Moverse hacia la derecha
            
            if (velocity.length() > 0) {
                velocity.normalize().multiplyScalar(MOVE_SPEED);
                const newPosition = targetPosition.clone().add(velocity);
                
                // --- Colisiones optimizadas ---
                const playerBox = new THREE.Box3().setFromCenterAndSize(newPosition, new THREE.Vector3(1.0, CAMERA_HEIGHT, 1.0));
                let collision = false;
                
                // Optimizaci√≥n: solo verificar colisiones cercanas
                const nearbyCollisions = collisionObjects.filter(wallBox => {
                    const distance = wallBox.getCenter(new THREE.Vector3()).distanceTo(newPosition);
                    return distance < 20; // Solo verificar objetos dentro de 20 unidades
                });
                
                for (const wallBox of nearbyCollisions) {
                    if (playerBox.intersectsBox(wallBox)) {
                        collision = true;
                        break;
                    }
                }
                
                if (!collision) {
                    targetPosition.copy(newPosition);
                }
            }

            // --- Cambio de Piso ---
            const floorStep = HALL_HEIGHT + 1;
            const targetY = currentFloor * floorStep + CAMERA_HEIGHT;
            targetPosition.y = targetY;

            // --- Interpolaci√≥n para suavidad ---
            camera.position.lerp(targetPosition, 0.2);
            camera.rotation.y = lerpAngle(camera.rotation.y, targetRotationY, 0.2);
        }

        function animate(currentTime) {
            requestAnimationFrame(animate);
            
            // Control de FPS
            const deltaTime = currentTime - lastTime;
            if (deltaTime < frameInterval) {
                return;
            }
            
            lastTime = currentTime - (deltaTime % frameInterval);
            frameCount++;
            
            // Actualizar el color del cielo cada minuto (60000 ms)
            if (currentTime - lastSkyUpdate > 60000) {
                scene.background = getSkyColor();
                lastSkyUpdate = currentTime;
            }
            
            updateMovement();
            updateAvatarPositions(); // Actualizar posiciones de avatares
            
            // Enviar posici√≥n del usuario cada 100ms (10 veces por segundo)
            if (frameCount % 6 === 0) { // 60 FPS / 6 = 10 veces por segundo
                sendUserPosition();
            }
            
            renderer.render(scene, camera);
        }
        
        // Funci√≥n para limpiar recursos
        function cleanup() {
            // Limpiar cache de texturas
            logoTextureCache.forEach(texture => {
                if (texture && texture.dispose) {
                    texture.dispose();
                }
            });
            logoTextureCache.clear();
            
            // Limpiar cache de materiales
            materialCache.forEach(material => {
                if (material && material.dispose) {
                    material.dispose();
                }
            });
            materialCache.clear();
            
            // Limpiar cache de texturas generadas
            textureCache.forEach(texture => {
                if (texture && texture.dispose) {
                    texture.dispose();
                }
            });
            textureCache.clear();
        }
        
        // Limpiar al cerrar la p√°gina
        window.addEventListener('beforeunload', cleanup);

        function lerpAngle(a, b, t) {
            let diff = b - a;
            while (diff < -Math.PI) diff += Math.PI * 2;
            while (diff > Math.PI) diff -= Math.PI * 2;
            return a + diff * t;
        }

        // --- Chat UI Logic ---
        const chatToggleBtn = document.getElementById('chat-toggle-btn');
        const chatPanel = document.getElementById('chat-panel');
        const chatCloseBtn = document.getElementById('chat-close-btn');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const emojiToggle = document.getElementById('emoji-toggle');
        const emojiPanel = document.getElementById('emoji-panel');
        const usersList = document.getElementById('users-list');
        const changeAliasBtn = document.getElementById('change-alias-btn');
        let userAlias = localStorage.getItem('userAlias') || '';
        let chatOpen = false;
        let connectedUsers = [];
        
        chatToggleBtn.onclick = () => {
            const simplePanel = document.getElementById('simple-panel');
            if (simplePanel && simplePanel.style.display === 'block') {
                closeSimplePanel();
            }
            chatPanel.style.display = 'flex';
            chatOpen = true;
            chatInput.focus();
            // El overlay NO debe mostrarse al abrir el chat
        };
        chatCloseBtn.onclick = () => {
            chatPanel.style.display = 'none';
            chatOpen = false;
            // El overlay NO debe ocultarse al cerrar el chat
        };

        // --- Emojis ---
        const emojis = ['üòä', 'üòÇ', '‚ù§Ô∏è', 'üëç', 'üéâ', 'üî•', 'üòé', 'ü§î', 'üò¢', 'üò°', 'üëã', 'üí™', 'üéØ', '‚≠ê', 'üíØ', 'üöÄ', 'üíé', 'üéÆ', 'üçï', '‚òï', 'üåÆ', 'üç∫', 'üéµ', 'üé¨', '‚öΩ', 'üèÄ', 'üéæ', 'üèà', '‚ö°', 'üåà', 'üåô', '‚òÄÔ∏è'];
        function createEmojiPanel() {
            emojiPanel.innerHTML = '';
            emojis.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-btn';
                btn.textContent = emoji;
                btn.onclick = () => {
                    chatInput.value += emoji;
                    chatInput.focus();
                    emojiPanel.style.display = 'none';
                };
                emojiPanel.appendChild(btn);
            });
        }
        emojiToggle.onclick = () => {
            if (emojiPanel.style.display === 'none' || !emojiPanel.style.display) {
                emojiPanel.style.display = 'flex';
                createEmojiPanel();
            } else {
                emojiPanel.style.display = 'none';
            }
        };

        document.addEventListener('click', (e) => {
            if (!emojiPanel.contains(e.target) && !emojiToggle.contains(e.target)) {
                emojiPanel.style.display = 'none';
            }
        });

        // --- Firebase Chat Logic ---
        function handleSendMessage() {
            const message = chatInput.value.trim();
            if (message.length > 0 && userAlias) {
                if (privateRecipient) {
                    sendPrivateMessage(privateRecipient, message);
                } else {
                    sendMessage(message);
                }
                chatInput.value = '';
            }
        }
        chatSendBtn.onclick = handleSendMessage;
        chatInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                handleSendMessage();
            }
        });

        // Alias setup and connect to chat
        if (!userAlias) {
            userAlias = 'Usuario_' + Math.floor(Math.random() * 10000);
            localStorage.setItem('userAlias', userAlias);
        }
        if (userAlias) {
            changeAliasBtn.style.display = 'flex';
        }
        connectToChat(userAlias); // Provided by firebase-config.js

        // --- Funciones de personalizaci√≥n de avatar ---
        const saveCustomizationBtn = document.getElementById('save-customization-btn');
        const resetCustomizationBtn = document.getElementById('reset-customization-btn');
        const shirtColorsGrid = document.getElementById('shirt-colors');
        const pantsColorsGrid = document.getElementById('pants-colors');
        const shoesColorsGrid = document.getElementById('shoes-colors');
        


        function openCustomizationPanel() {
            console.log('Abriendo panel simple de personalizaci√≥n');
            
            // Cerrar chat si est√° abierto
            if (chatOpen) {
                chatPanel.style.display = 'none';
                chatOpen = false;
            }
            
            const simplePanel = document.getElementById('simple-panel');
            if (simplePanel) {
                // Actualizar el alias actual
                const currentAliasElement = document.getElementById('current-alias');
                if (currentAliasElement) {
                    currentAliasElement.textContent = userAlias || 'Sin alias';
                }
                
                // Poblar el input con el alias actual
                const aliasInput = document.getElementById('simple-alias-input');
                if (aliasInput) {
                    aliasInput.value = userAlias || '';
                    // Agregar event listener para actualizar vista previa en tiempo real
                    aliasInput.addEventListener('input', function() {
                        updateAvatarPreview();
                    });
                }
                
                // Mostrar el panel
                simplePanel.style.display = 'block';
                customizationPanelOpen = true;
                
                // Inicializar vista previa del avatar
                updateAvatarPreview();
                
                console.log('‚úÖ Panel simple mostrado');
                            // Mostrar overlay y bloquear clics
            const overlay = document.getElementById('ui-overlay');
            if (overlay) {
                overlay.style.display = 'block';
                overlay.style.pointerEvents = 'auto';
                overlay.style.zIndex = '20000';
            }
            // Asegurar que el panel est√© por encima
            simplePanel.style.zIndex = '21000';
            simplePanel.style.pointerEvents = 'auto';
            } else {
                console.log('‚ùå Panel simple no encontrado');
            }
        }
        

        
        function changeShirtColor(color) {
            console.log('Cambiando color de camisa a:', color);
            shirtColor = color;
            currentCustomization.shirtColor = color;
            updateAvatarPreview();
            updateColorButtonSelection('shirt', color);
        }
        
        function changePantsColor(color) {
            console.log('Cambiando color de pantal√≥n a:', color);
            pantsColor = color;
            
            // Actualizar el avatar en tiempo real usando el sistema correcto
            const avatar = userAvatars.get(userAlias);
            if (avatar && avatar.pantsMaterial) {
                avatar.pantsMaterial.color.setHex(color);
                avatar.pantsMaterial.needsUpdate = true;
            }
            
            // Actualizar vista previa
            updateAvatarPreview();
            
            // Feedback visual en los botones
            updateColorButtonSelection('pants', color);
        }
        
        function changeShoesColor(color) {
            console.log('Cambiando color de zapatos a:', color);
            shoesColor = color;
            
            // Actualizar el avatar en tiempo real usando el sistema correcto
            const avatar = userAvatars.get(userAlias);
            if (avatar && avatar.shoeMaterial) {
                avatar.shoeMaterial.color.setHex(color);
                avatar.shoeMaterial.needsUpdate = true;
            }
            
            // Actualizar vista previa
            updateAvatarPreview();
            
            // Feedback visual en los botones
            updateColorButtonSelection('shoes', color);
        }
        
        function updateColorButtonSelection(type, selectedColor) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.color-option').forEach(btn => {
                btn.style.borderColor = 'transparent';
                btn.style.transform = 'scale(1)';
            });
            
            // Marcar el bot√≥n seleccionado
            const selectedBtn = document.querySelector(`[data-color="${selectedColor}"]`);
            if (selectedBtn) {
                selectedBtn.style.borderColor = '#FFD700';
                selectedBtn.style.transform = 'scale(1.1)';
                selectedBtn.style.boxShadow = '0 0 10px rgba(255, 215, 0, 0.5)';
            }
        }
        
        function updateAvatarPreview() {
            const previewDiv = document.getElementById('avatar-preview');
            const aliasInput = document.getElementById('simple-alias-input');
            // Eliminar referencia a preview-alias
            if (previewDiv) {
                // Actualizar el alias en la vista previa
                const currentAlias = aliasInput ? aliasInput.value.trim() : userAlias;
                // Crear una vista previa visual del avatar m√°s detallada
                const shirtColorHex = shirtColor.toString(16).padStart(6, '0');
                const pantsColorHex = pantsColor.toString(16).padStart(6, '0');
                const shoesColorHex = shoesColor.toString(16).padStart(6, '0');
                previewDiv.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 0; position: relative; width: 90px; height: 180px;">
                        <!-- Cabeza cuadrada -->
                        <div style="width: 40px; height: 40px; background: #FFE4C4; border: 2px solid #333; position: relative; margin-bottom: 0;">
                            <!-- Ojos -->
                            <div style="position: absolute; top: 12px; left: 10px; width: 6px; height: 6px; background: #222; border-radius: 1px;"></div>
                            <div style="position: absolute; top: 12px; right: 10px; width: 6px; height: 6px; background: #222; border-radius: 1px;"></div>
                            <!-- Boca -->
                            <div style="position: absolute; bottom: 10px; left: 12px; width: 16px; height: 4px; background: #222; border-radius: 1px;"></div>
                        </div>
                        <!-- Torso y brazos -->
                        <div style="display: flex; flex-direction: row; align-items: flex-start; height: 50px;">
                            <!-- Brazo izquierdo -->
                            <div style="width: 16px; height: 50px; background: #${shirtColorHex}; border: 2px solid #333; margin-right: 0;"></div>
                            <!-- Torso -->
                            <div style="width: 28px; height: 50px; background: #${shirtColorHex}; border: 2px solid #333; margin: 0 0;"></div>
                            <!-- Brazo derecho -->
                            <div style="width: 16px; height: 50px; background: #${shirtColorHex}; border: 2px solid #333; margin-left: 0;"></div>
                        </div>
                        <!-- Piernas -->
                        <div style="display: flex; flex-direction: row; align-items: flex-start; height: 50px; margin-top: 0;">
                            <!-- Pierna izquierda -->
                            <div style="width: 16px; height: 50px; background: #${pantsColorHex}; border: 2px solid #333; margin-right: 4px;"></div>
                            <!-- Pierna derecha -->
                            <div style="width: 16px; height: 50px; background: #${pantsColorHex}; border: 2px solid #333; margin-left: 4px;"></div>
                        </div>
                        <!-- Zapatos -->
                        <div style="display: flex; flex-direction: row; align-items: flex-start; height: 12px; margin-top: -2px;">
                            <!-- Pie izquierdo -->
                            <div style="width: 16px; height: 12px; background: #${shoesColorHex}; border: 2px solid #333; margin-right: 4px;"></div>
                            <!-- Pie derecho -->
                            <div style="width: 16px; height: 12px; background: #${shoesColorHex}; border: 2px solid #333; margin-left: 4px;"></div>
                        </div>
                        <!-- Nombre del avatar -->
                        <div style="color: #FFD700; font-size: 12px; font-weight: bold; text-align: center; margin-top: 8px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); width: 100%;">${currentAlias || 'Sin nombre'}</div>
                    </div>
                `;
            }
        }
        
        function resetSimpleCustomization() {
            console.log('Restableciendo personalizaci√≥n');
            
            // Restablecer colores por defecto
            shirtColor = 0xFF6B6B;
            pantsColor = 0x2C3E50;
            shoesColor = 0x8B4513;
            
            // Restablecer alias
            userAlias = '';
            const aliasInput = document.getElementById('simple-alias-input');
            if (aliasInput) {
                aliasInput.value = '';
            }
            
            // Actualizar avatar en tiempo real usando el sistema correcto
            const avatar = userAvatars.get(userAlias);
            if (avatar) {
                if (avatar.bodyMaterial) avatar.bodyMaterial.color.setHex(shirtColor);
                if (avatar.pantsMaterial) avatar.pantsMaterial.color.setHex(pantsColor);
                if (avatar.shoeMaterial) avatar.shoeMaterial.color.setHex(shoesColor);
                
                // Forzar actualizaci√≥n de materiales
                if (avatar.bodyMaterial) avatar.bodyMaterial.needsUpdate = true;
                if (avatar.pantsMaterial) avatar.pantsMaterial.needsUpdate = true;
                if (avatar.shoeMaterial) avatar.shoeMaterial.needsUpdate = true;
            }
            
            // Actualizar vista previa
            updateAvatarPreview();
            
            // Limpiar selecci√≥n de botones
            document.querySelectorAll('.color-option').forEach(btn => {
                btn.style.borderColor = 'transparent';
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = 'none';
            });
            
            console.log('‚úÖ Personalizaci√≥n restablecida');
        }
        
        function saveSimpleCustomization() {
            console.log('Guardando personalizaci√≥n');
            
            const aliasInput = document.getElementById('simple-alias-input');
            const newAlias = aliasInput ? aliasInput.value.trim() : '';
            
            // Validar alias
            if (newAlias.length > 20) {
                alert('El nombre no puede tener m√°s de 20 caracteres');
                return;
            }
            
            // Guardar alias
            userAlias = newAlias;
            
            // Guardar en localStorage
            const customizationData = {
                alias: userAlias,
                shirtColor: shirtColor,
                pantsColor: pantsColor,
                shoesColor: shoesColor
            };
            
            localStorage.setItem('avatarCustomization', JSON.stringify(customizationData));
            
            // Actualizar nombre en el avatar
            updateAvatarName();
            
            // Enviar alias al servidor si est√° conectado
            if (isConnected) {
                sendAlias();
            }
            
            // Cerrar panel
            closeSimplePanel();
            
            console.log('‚úÖ Personalizaci√≥n guardada:', customizationData);
        }
        
        function closeSimplePanel() {
            const panel = document.getElementById('simple-panel');
            if (panel) {
                panel.style.display = 'none';
                customizationPanelOpen = false;
                // Ocultar overlay y permitir clics
                const overlay = document.getElementById('ui-overlay');
                if (overlay) {
                    overlay.style.display = 'none';
                    overlay.style.pointerEvents = 'none';
                }
                panel.style.zIndex = '21000';
                panel.style.pointerEvents = 'auto';
                console.log('Panel simple cerrado');
            }
        }
        
        // Event listeners para actualizaci√≥n en tiempo real
        document.addEventListener('DOMContentLoaded', function() {
            const aliasInput = document.getElementById('simple-alias-input');
            if (aliasInput) {
                aliasInput.addEventListener('input', function() {
                    updateAvatarPreview();
                });
            }
        });

        function closeWorkingPanel() {
            const panel = document.getElementById('working-customization-panel');
            if (panel) {
                panel.remove();
            }
            customizationPanelOpen = false;
        }
        
        function changeShirtColor(color) {
            currentCustomization.shirtColor = color;
            applyCustomizationToAvatar();
            console.log('Color de camisa cambiado a:', color);
        }
        
        function saveSimpleCustomization() {
            const aliasInput = document.getElementById('simple-alias-input');
            const newAlias = aliasInput.value.trim();
            
            if (newAlias.length > 0) {
                userAlias = newAlias;
                localStorage.setItem('userAlias', userAlias);
                
                if (isConnected) {
                    sendAlias();
                }
                
                console.log('Alias guardado:', newAlias);
            }
            
            localStorage.setItem('avatarCustomization', JSON.stringify(currentCustomization));
            closeSimplePanel();
            alert('¬°Personalizaci√≥n guardada!');
        }
        
        function createWorkingColorGrids() {
            // Crear opciones de color para camisas (primeros 18 colores)
            const shirtGrid = document.getElementById('working-shirt-colors');
            for (let i = 0; i < 18; i++) {
                const colorOption = document.createElement('div');
                colorOption.style.cssText = `
                    width: 40px;
                    height: 40px;
                    border: 3px solid transparent;
                    border-radius: 8px;
                    cursor: pointer;
                    background-color: #${customizationColors[i].toString(16).padStart(6, '0')};
                `;
                colorOption.onclick = () => selectWorkingColor(customizationColors[i], 'shirt');
                if (customizationColors[i] === currentCustomization.shirtColor) {
                    colorOption.style.borderColor = '#FFD700';
                }
                shirtGrid.appendChild(colorOption);
            }
            

        }
        

        

        

        


        function closeCustomizationPanel() {
            customizationPanel.style.display = 'none';
            customizationPanelOpen = false;
        }

        function createColorGrids() {
            // Limpiar grids existentes
            const shirtColorsGrid = document.getElementById('shirt-colors');
            const pantsColorsGrid = document.getElementById('pants-colors');
            const shoesColorsGrid = document.getElementById('shoes-colors');

            shirtColorsGrid.innerHTML = '';
            pantsColorsGrid.innerHTML = '';
            shoesColorsGrid.innerHTML = '';

            // Definir los colores disponibles para cada tipo
            // Colores para camisas (colores vibrantes y variados)
            const shirtColors = [
                { color: 0xFF6B6B, name: 'Rosado' },
                { color: 0x4ECDC4, name: 'Turquesa' },
                { color: 0x45B7D1, name: 'Azul Marino' },
                { color: 0x96CEB4, name: 'Verde Claro' },
                { color: 0xFFEAA7, name: 'Amarillo' },
                { color: 0xDDA0DD, name: 'Lila' },
                { color: 0x98D8C8, name: 'Verde Agua' },
                { color: 0xF7DC6F, name: 'Amarillo Dorado' },
                { color: 0xBB8FCE, name: 'Morado' },
                { color: 0x85C1E9, name: 'Azul Cielo' },
                { color: 0xF8C471, name: 'Naranja' },
                { color: 0x82E0AA, name: 'Verde Hoja' }
            ];

            // Colores para pantalones (colores m√°s sobrios y neutros)
            const pantsColors = [
                { color: 0x2C3E50, name: 'Gris Oscuro' },
                { color: 0x3498DB, name: 'Azul' },
                { color: 0xE74C3C, name: 'Rojo' },
                { color: 0x9B59B6, name: 'Violeta' },
                { color: 0x34495E, name: 'Azul Oscuro' },
                { color: 0x2ECC71, name: 'Verde' },
                { color: 0x16A085, name: 'Verde Agua' },
                { color: 0x2980B9, name: 'Azul Marino' },
                { color: 0x8E44AD, name: 'Morado' }
            ];

            // Colores para zapatos (colores oscuros y neutros)
            const shoesColors = [
                { color: 0x8B4513, name: 'Marr√≥n' },
                { color: 0x6E2C00, name: 'Marr√≥n Oscuro' },
                { color: 0x1A5276, name: 'Azul Marino' },
                { color: 0x154360, name: 'Azul Oscuro' }
            ];

            // Crear opciones de color para cada tipo
            const createOption = (colorObj, type) => {
                const option = document.createElement('div');
                option.className = 'color-option';
                option.style.setProperty('--color', '#' + colorObj.color.toString(16).padStart(6, '0'));
                option.dataset.color = colorObj.color;
                option.dataset.type = type;
                
                // Agregar t√≠tulo al pasar el mouse
                option.title = colorObj.name;
                
                // Agregar evento click
                option.onclick = () => selectColor(colorObj.color, type);
                
                return option;
            };

            // Crear botones para cada tipo
            shirtColors.forEach(color => shirtColorsGrid.appendChild(createOption(color, 'shirt')));
            pantsColors.forEach(color => pantsColorsGrid.appendChild(createOption(color, 'pants')));
            shoesColors.forEach(color => shoesColorsGrid.appendChild(createOption(color, 'shoes')));

            // Actualizar selecciones iniciales
            updateSelectedColors();
        }

        // Inicializar los grids de colores al cargar
        document.addEventListener('DOMContentLoaded', createColorGrids);



        function selectColor(color, type) {
            // Remover selecci√≥n previa del mismo tipo
            const allSelected = document.querySelectorAll(`.color-option.selected[data-type="${type}"]`);
            allSelected.forEach(btn => btn.classList.remove('selected'));
            
            // Seleccionar nueva opci√≥n
            const selectedOption = document.querySelector(`[data-color="${color}"][data-type="${type}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            // Actualizar color actual
            switch (type) {
                case 'shirt':
                    currentCustomization.shirtColor = color;
                    break;
                case 'pants':
                    currentCustomization.pantsColor = color;
                    break;
                case 'shoes':
                    currentCustomization.shoesColor = color;
                    break;
            }
            
            // Actualizar selecciones visuales
            updateSelectedColors();
            
            // Aplicar cambios inmediatamente al avatar
            applyCustomizationToAvatar();
        }

        function updateSelectedColors() {
            // Actualizar selecciones visuales
            const shirtOption = document.querySelector(`[data-color="${currentCustomization.shirtColor}"][data-type="shirt"]`);
            const pantsOption = document.querySelector(`[data-color="${currentCustomization.pantsColor}"][data-type="pants"]`);
            const shoesOption = document.querySelector(`[data-color="${currentCustomization.shoesColor}"][data-type="shoes"]`);
            
            if (shirtOption) shirtOption.classList.add('selected');
            if (pantsOption) pantsOption.classList.add('selected');
            if (shoesOption) shoesOption.classList.add('selected');
        }

        function applyCustomizationToAvatar() {
            // Actualizar las variables globales
            shirtColor = currentCustomization.shirtColor;
            pantsColor = currentCustomization.pantsColor;
            shoesColor = currentCustomization.shoesColor;
            
            // Actualizar la vista previa existente
            updateAvatarPreview();
            
            // Actualizar los colores en el localStorage
            const customizationData = {
                shirtColor: currentCustomization.shirtColor,
                pantsColor: currentCustomization.pantsColor,
                shoesColor: currentCustomization.shoesColor
            };
            localStorage.setItem('avatarCustomization', JSON.stringify(customizationData));
        }

        function saveCustomization() {
            // Obtener el nuevo alias del input
            const aliasInput = document.getElementById('customization-alias-input');
            const newAlias = aliasInput.value.trim();
            
            // Validar el alias
            if (newAlias.length === 0) {
                addMessageToChat('Sistema', 'El alias no puede estar vac√≠o', 'system');
                return;
            }
            
            if (newAlias.length > 18) {
                addMessageToChat('Sistema', 'El alias no puede tener m√°s de 18 caracteres', 'system');
                return;
            }
            
            // Actualizar el alias si ha cambiado
            if (newAlias !== userAlias) {
                userAlias = newAlias;
                localStorage.setItem('userAlias', userAlias);
                
                // Enviar nuevo alias al servidor
                if (isConnected) {
                    sendAlias();
                }
            }
            
            // Guardar personalizaci√≥n en localStorage
            localStorage.setItem('avatarCustomization', JSON.stringify(currentCustomization));
            closeCustomizationPanel();
            
            // Mostrar mensaje de confirmaci√≥n
            addMessageToChat('Sistema', 'Personalizaci√≥n guardada exitosamente', 'system');
        }

        function resetCustomization() {
            // Restablecer a colores por defecto
            currentCustomization = {
                shirtColor: 0x4ECDC4,
                pantsColor: 0x2C3E50,
                shoesColor: 0x8B4513
            };
            
            // Aplicar cambios
            applyCustomizationToAvatar();
            updateSelectedColors();
        }

        function loadCustomization() {
            const saved = localStorage.getItem('avatarCustomization');
            if (saved) {
                try {
                    currentCustomization = JSON.parse(saved);
                    applyCustomizationToAvatar();
                } catch (error) {
                    console.error('Error cargando personalizaci√≥n:', error);
                }
            }
        }



        // Cerrar panel al hacer clic fuera - VERSI√ìN MEJORADA
        document.addEventListener('click', (e) => {
            // Verificar si el clic es en un bot√≥n de UI - NO cerrar en ese caso
            const isUIButton = e.target.closest('#chat-toggle-btn') || 
                              e.target.closest('#change-alias-btn') || 
                              e.target.closest('#chat-panel') || 
                              e.target.closest('#simple-panel') ||
                              e.target.closest('#ui-overlay');
            
            if (isUIButton) {
                return; // No hacer nada si el clic es en un elemento de UI
            }
            
            // Cerrar chat si est√° abierto y se hace clic fuera
            if (chatOpen && !chatPanel.contains(e.target) && !chatToggleBtn.contains(e.target)) {
                chatPanel.style.display = 'none';
                chatOpen = false;
                // Ocultar overlay
                const overlay = document.getElementById('ui-overlay');
                if (overlay) {
                    overlay.style.display = 'none';
                    overlay.style.pointerEvents = 'none';
                }
            }
            
            if (customizationPanelOpen && !customizationPanel.contains(e.target)) {
                closeCustomizationPanel();
            }
            
            // Cerrar panel de trabajo al hacer clic fuera
            const workingPanel = document.getElementById('working-customization-panel');
            if (workingPanel && !workingPanel.contains(e.target)) {
                closeWorkingPanel();
            }
        });

        // Agregar event listener al overlay para bloquear clics - VERSI√ìN MEJORADA
        const overlay = document.getElementById('ui-overlay');
        if (overlay) {
            overlay.addEventListener('click', (e) => {
                // Solo bloquear clics si el overlay est√° activo y el clic no es en un bot√≥n de UI
                const isUIButton = e.target.closest('#chat-toggle-btn') || 
                                  e.target.closest('#change-alias-btn') || 
                                  e.target.closest('#chat-panel') || 
                                  e.target.closest('#simple-panel');
                
                if (!isUIButton && overlay.style.display === 'block' && overlay.style.pointerEvents === 'auto') {
                e.stopPropagation();
                e.preventDefault();
                return false;
                }
            });
        }

        // Cargar personalizaci√≥n al iniciar
        loadCustomization();

        function sendUserPosition() {
            if (userAlias) {
                // TODO: Enviar posici√≥n a Firebase
                // firebase.database().ref('positions').child(userAlias).set({ ... })
            }
        }

        function updateAvatarPosition(alias, position, floor, rotation = 0) {
            if (!position || typeof position.x !== 'number' || typeof position.y !== 'number' || typeof position.z !== 'number') {
                console.warn('Posici√≥n inv√°lida para alias:', alias, position);
                return;
            }
            if (typeof floor !== 'number') {
                console.warn('Floor inv√°lido para alias:', alias, floor);
                return;
            }
            if (typeof rotation !== 'number') {
                console.warn('Rotaci√≥n inv√°lida para alias:', alias, rotation);
                return;
            }
            // No crear avatar para el usuario propio
            if (alias === userAlias) {
                return;
            }
            let avatar = userAvatars.get(alias);
            if (!avatar) {
                createUserAvatar(alias, position, floor);
                avatar = userAvatars.get(alias);
            }
            if (avatar) {
                const floorStep = HALL_HEIGHT + 1;
                const targetY = floor * floorStep + 0.6; // Punto intermedio entre 0.2 y 1.0
                avatar.targetPosition.set(position.x, targetY, position.z);
                avatar.currentFloor = floor;
                avatar.group.position.y = targetY;
                let normalizedRotation = rotation;
                while (normalizedRotation > Math.PI) normalizedRotation -= 2 * Math.PI;
                while (normalizedRotation < -Math.PI) normalizedRotation += 2 * Math.PI;
                avatar.targetRotation = normalizedRotation;
                const rotationDegrees = (normalizedRotation * 180 / Math.PI).toFixed(1);
                // Opcional: console.log(`Avatar ${alias} rotaci√≥n actualizada a: ${rotationDegrees}¬∞ (${normalizedRotation.toFixed(3)} rad)`);
            }
        }

        // Asegurar que el DOM est√© completamente cargado antes de inicializar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // Configurar overlay al cargar la p√°gina - VERSI√ìN MEJORADA
        document.addEventListener('DOMContentLoaded', () => {
            const overlay = document.getElementById('ui-overlay');
            if (overlay) {
                overlay.style.pointerEvents = 'auto';
                overlay.addEventListener('click', (e) => {
                    // Solo bloquear clics si el overlay est√° activo y el clic no es en un bot√≥n de UI
                    const isUIButton = e.target.closest('#chat-toggle-btn') || 
                                      e.target.closest('#change-alias-btn') || 
                                      e.target.closest('#chat-panel') || 
                                      e.target.closest('#simple-panel');
                    
                    if (!isUIButton && overlay.style.display === 'block' && overlay.style.pointerEvents === 'auto') {
                    e.stopPropagation();
                    e.preventDefault();
                    return false;
                    }
                });
            }
        });

        
       

        // Mostrar prompt de alias si no existe
        if (!userAlias) {
            userAlias = prompt('Ingresa tu alias:');
            if (userAlias) {
                localStorage.setItem('userAlias', userAlias);
            } else {
                userAlias = 'Usuario_' + Math.floor(Math.random() * 10000);
                localStorage.setItem('userAlias', userAlias);
            }
        }

        // Conectar al chat de Firebase
        connectToChat(userAlias);

        

        // Enviar posici√≥n del usuario peri√≥dicamente (ejemplo cada 500ms)
        setInterval(() => {
            if (
                typeof camera !== 'undefined' &&
                camera.position &&
                typeof camera.position.x !== 'undefined' &&
                typeof camera.position.y !== 'undefined' &&
                typeof camera.position.z !== 'undefined'
            ) {
                const position = {
                    x: camera.position.x,
                    y: camera.position.y,
                    z: camera.position.z
                };
                const floor = typeof currentFloor !== 'undefined' ? currentFloor : 0;
                // Invertir la rotaci√≥n para que los avatares miren igual que la c√°mara
                const rotation = typeof camera.rotation !== 'undefined' ? -camera.rotation.y : 0;
                sendPosition(position, floor, rotation);
            } else {
                console.warn('C√°mara o posici√≥n no definida:', camera);
            }
        }, 500);

        // Funci√≥n mejorada para mostrar mensajes en el chat
        function addMessageToChat(alias, message, type = 'user', timestamp = null) {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages) return;
            let timeStr = '';
            if (timestamp) {
                const date = new Date(timestamp);
                timeStr = `<span style="color:#aaa; font-size:11px; margin-left:8px;">${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>`;
            }
            const isOwn = (alias === userAlias || type === 'own');
            const msgDiv = document.createElement('div');
            msgDiv.className = isOwn ? 'chat-message own' : 'chat-message';
            msgDiv.style.margin = '6px 0';
            msgDiv.style.textAlign = isOwn ? 'right' : 'left';
            msgDiv.innerHTML = `
                <span style="color:${isOwn ? '#FFD700' : '#4ECDC4'}; font-weight:bold;">${alias}:</span>
                <span style="color:#fff;">${message}</span>
                ${timeStr}
            `;
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Listener de mensajes de Firebase
        messagesRef.off('child_added'); // <-- Evita listeners duplicados
        messagesRef.on('child_added', (snapshot) => {
            const msg = snapshot.val();
            addMessageToChat(msg.alias, msg.message, msg.alias === userAlias ? 'own' : 'user', msg.timestamp);
        });

        // Listener de posiciones de avatares en Firebase
        positionsRef.on('value', (snapshot) => {
            const positions = snapshot.val() || {};
            Object.keys(positions).forEach(alias => {
                    const userData = positions[alias];
                if (
                    alias !== userAlias &&
                    userData &&
                    userData.position && typeof userData.position.x === 'number' &&
                    typeof userData.position.y === 'number' &&
                    typeof userData.position.z === 'number' &&
                    typeof userData.floor === 'number' &&
                    typeof userData.rotation === 'number'
                ) {
                    updateAvatarPosition(alias, userData.position, userData.floor, userData.rotation);
                }
            });
            // Eliminar avatares de usuarios que ya no est√°n
            Object.keys(userAvatars).forEach(alias => {
                if (!positions[alias] && alias !== userAlias) {
                    removeUserAvatar(alias);
                }
            });
        });

        // --- Funci√≥n para crear un avatar de usuario ---
        function createUserAvatar(alias, position = {x:0, y:0, z:0}, floor = 0) {
            if (userAvatars.has(alias)) return;
            const avatarGroup = new THREE.Group();
            avatarGroup.position.set(position.x, position.y, position.z);
            // Geometr√≠a visible para el avatar (cubo simple)
            const geometry = new THREE.BoxGeometry(1, 2, 1);
            const material = new THREE.MeshStandardMaterial({ color: 0xFFD700 });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.castShadow = false;
            avatarGroup.add(mesh);
            scene.add(avatarGroup);
            userAvatars.set(alias, {
                group: avatarGroup,
                targetPosition: new THREE.Vector3(position.x, position.y, position.z),
                targetRotation: 0,
                currentFloor: floor
            });
        }
        // --- Funci√≥n para actualizar todas las posiciones de avatares ---
        function updateAvatarPositions() {
            userAvatars.forEach((avatar, alias) => {
                // Interpolaci√≥n suave hacia la posici√≥n objetivo
                avatar.group.position.lerp(avatar.targetPosition, 0.2);
                // Interpolaci√≥n suave de rotaci√≥n
                avatar.group.rotation.y += (avatar.targetRotation - avatar.group.rotation.y) * 0.2;
                // Animaci√≥n de movimiento estilo Roblox
                animateRobloxAvatar(avatar, alias);
            });
        }

        function openSimplePanel() {
            const panel = document.getElementById('simple-panel');
            if (panel) {
                panel.style.display = 'block';
                customizationPanelOpen = true;
                // Inicializar vista previa del avatar
                updateAvatarPreview();
                // Inicializar los grids de colores
                createColorGrids();
                // Actualizar selecciones de colores
                updateSelectedColors();
            }
        }

        // Inicializaci√≥n robusta de colores de avatar
        if (typeof shirtColor === 'undefined' || shirtColor === null) shirtColor = 0x4ECDC4;
        if (typeof pantsColor === 'undefined' || pantsColor === null) pantsColor = 0x2C3E50;
        if (typeof shoesColor === 'undefined' || shoesColor === null) shoesColor = 0x8B4513;

        let privateRecipient = null;
        
        // UI: Al hacer clic en un usuario, activar modo privado
        usersList.addEventListener('click', function(e) {
            const userItem = e.target.closest('.user-item');
            if (userItem && !userItem.classList.contains('own')) {
                privateRecipient = userItem.textContent.replace(' (T√∫)', '').trim();
                chatInput.placeholder = `Mensaje privado a: ${privateRecipient}`;
                chatInput.focus();
                document.getElementById('private-mode-indicator')?.remove();
                const indicator = document.createElement('div');
                indicator.id = 'private-mode-indicator';
                indicator.textContent = `Modo privado con: ${privateRecipient}`;
                indicator.style = 'background:#FFD700;color:#222;padding:4px 10px;border-radius:6px;margin-bottom:4px;font-weight:bold;text-align:center;';
                chatInput.parentElement.insertBefore(indicator, chatInput);
                // Bot√≥n para salir del modo privado
                const exitBtn = document.createElement('button');
                exitBtn.textContent = 'Volver a chat p√∫blico';
                exitBtn.style = 'margin-left:10px;padding:2px 8px;border-radius:4px;border:none;background:#800000;color:#fff;cursor:pointer;font-size:12px;';
                exitBtn.onclick = function() {
                    privateRecipient = null;
                    chatInput.placeholder = 'Escribe un mensaje...';
                    indicator.remove();
                };
                indicator.appendChild(exitBtn);
            }
        });
        
        // Diferenciar mensajes privados en el chat
        function addMessageToChat(alias, message, type = 'user', timestamp = null, isPrivate = false, recipient = null) {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages) return;
            let timeStr = '';
            if (timestamp) {
                const date = new Date(timestamp);
                timeStr = `<span style="color:#aaa; font-size:11px; margin-left:8px;">${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>`;
            }
            const isOwn = (alias === userAlias || type === 'own');
            const msgDiv = document.createElement('div');
            msgDiv.className = isOwn ? 'chat-message own' : 'chat-message';
            msgDiv.style.margin = '6px 0';
            msgDiv.style.textAlign = isOwn ? 'right' : 'left';
            if (isPrivate) {
                msgDiv.style.background = 'rgba(255,215,0,0.12)';
                msgDiv.style.border = '1px solid #FFD700';
                msgDiv.innerHTML = `<span style="color:${isOwn ? '#FFD700' : '#4ECDC4'}; font-weight:bold;">${alias} (privado):</span> <span style="color:#fff;">${message}</span> ${timeStr}`;
            } else {
                msgDiv.innerHTML = `<span style="color:${isOwn ? '#FFD700' : '#4ECDC4'}; font-weight:bold;">${alias}:</span> <span style="color:#fff;">${message}</span> ${timeStr}`;
            }
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Eliminar definici√≥n duplicada de addMessageToChat y el listener de mensajes p√∫blicos en index.html
        // Dejar solo la versi√≥n de addMessageToChat que soporta mensajes privados y exponerla en window
        window.addMessageToChat = addMessageToChat;

        // --- Enviar posici√≥n del usuario peri√≥dicamente SOLO si est√° conectado y sin duplicados ---
        let positionInterval = null;
        function startPositionUpdates() {
            if (positionInterval) clearInterval(positionInterval);
            positionInterval = setInterval(() => {
                if (
                    typeof camera !== 'undefined' &&
                    camera.position &&
                    typeof camera.position.x !== 'undefined' &&
                    typeof camera.position.y !== 'undefined' &&
                    typeof camera.position.z !== 'undefined'
                ) {
                    const position = {
                        x: camera.position.x,
                        y: camera.position.y,
                        z: camera.position.z
                    };
                    const floor = typeof currentFloor !== 'undefined' ? currentFloor : 0;
                    const rotation = typeof camera.rotation !== 'undefined' ? -camera.rotation.y : 0;
                    sendPosition(position, floor, rotation);
                }
            }, 500);
        }
        function stopPositionUpdates() {
            if (positionInterval) clearInterval(positionInterval);
            positionInterval = null;
        }
        // Iniciar al conectar
        document.addEventListener('DOMContentLoaded', () => {
            connectToChat(userAlias);
            startPositionUpdates();
        });
        // Limpiar al cerrar la p√°gina
        window.addEventListener('beforeunload', () => {
            stopPositionUpdates();
            disconnectFromChat();
        });

        // --- Funci√≥n reutilizable para crear un avatar estilo Roblox ---
        function createRobloxAvatar(options) {
            const group = new THREE.Group();
            // Opciones y colores
            const shirtColor = options.shirtColor || 0x4ECDC4;
            const pantsColor = options.pantsColor || 0x2C3E50;
            const shoesColor = options.shoesColor || 0x8B4513;
            const skinColor = 0xFFE4C4;
            // Cabeza
            const headGeometry = new THREE.BoxGeometry(0.8, 0.8, 0.8);
            const headMaterial = new THREE.MeshStandardMaterial({ color: skinColor });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.set(0, 1.7, 0);
            group.add(head);
            // Torso
            const bodyGeometry = new THREE.BoxGeometry(1, 1.2, 0.5);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: shirtColor });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.set(0, 0.9, 0);
            group.add(body);
            // Brazos
            const armGeometry = new THREE.BoxGeometry(0.35, 1, 0.35);
            const armMaterial = new THREE.MeshStandardMaterial({ color: shirtColor });
            const leftArm = new THREE.Mesh(armGeometry, armMaterial);
            leftArm.position.set(-0.7, 1.1, 0);
            group.add(leftArm);
            const rightArm = new THREE.Mesh(armGeometry, armMaterial);
            rightArm.position.set(0.7, 1.1, 0);
            group.add(rightArm);
            // Piernas
            const legGeometry = new THREE.BoxGeometry(0.38, 1, 0.38);
            const legMaterial = new THREE.MeshStandardMaterial({ color: pantsColor });
            const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
            leftLeg.position.set(-0.25, 0.0, 0);
            group.add(leftLeg);
            const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
            rightLeg.position.set(0.25, 0.0, 0);
            group.add(rightLeg);
            // Zapatos
            const shoeGeometry = new THREE.BoxGeometry(0.38, 0.18, 0.38);
            const shoeMaterial = new THREE.MeshStandardMaterial({ color: shoesColor });
            const leftShoe = new THREE.Mesh(shoeGeometry, shoeMaterial);
            leftShoe.position.set(-0.25, -0.5, 0);
            group.add(leftShoe);
            const rightShoe = new THREE.Mesh(shoeGeometry, shoeMaterial);
            rightShoe.position.set(0.25, -0.5, 0);
            group.add(rightShoe);
            // Materiales para personalizaci√≥n en tiempo real
            group.bodyMaterial = bodyMaterial;
            group.pantsMaterial = legMaterial;
            group.shoeMaterial = shoeMaterial;
            return group;
        }

        // --- Funci√≥n para crear un avatar de usuario (propio o de otros) ---
        function createUserAvatar(alias, position = {x:0, y:0, z:0}, floor = 0, custom = {}) {
            if (userAvatars.has(alias)) return;
            // Obtener colores personalizados si existen
            const shirtColor = custom.shirtColor || 0x4ECDC4;
            const pantsColor = custom.pantsColor || 0x2C3E50;
            const shoesColor = custom.shoesColor || 0x8B4513;
            const avatarGroup = createRobloxAvatar({ shirtColor, pantsColor, shoesColor });
            
            // Calcular la posici√≥n Y correcta para el piso
            const floorStep = HALL_HEIGHT + 1;
            const correctY = floor * floorStep + 0.6; // Punto intermedio entre 0.2 y 1.0
            
            avatarGroup.position.set(position.x, correctY, position.z);
            scene.add(avatarGroup);
            userAvatars.set(alias, {
                group: avatarGroup,
                targetPosition: new THREE.Vector3(position.x, correctY, position.z),
                targetRotation: 0,
                currentFloor: floor,
                bodyMaterial: avatarGroup.bodyMaterial,
                pantsMaterial: avatarGroup.pantsMaterial,
                shoeMaterial: avatarGroup.shoeMaterial
            });
        }

        // --- Animaci√≥n de movimiento estilo Roblox ---
        function animateRobloxAvatar(avatar, alias) {
            if (!avatar || alias === userAlias) return; // No animar el propio (lo ve en primera persona)
            // Calcular velocidad de movimiento
            const velocity = avatar.group.position.distanceTo(avatar.targetPosition);
            // Si se est√° moviendo, animar
            if (velocity > 0.01) {
                const time = performance.now() * 0.002 + avatar.group.position.x * 0.1;
                const swing = Math.sin(time * 8) * 0.4;
                // Brazos
                if (avatar.group.children[2]) avatar.group.children[2].rotation.x = swing; // leftArm
                if (avatar.group.children[3]) avatar.group.children[3].rotation.x = -swing; // rightArm
                // Piernas
                if (avatar.group.children[4]) avatar.group.children[4].rotation.x = -swing; // leftLeg
                if (avatar.group.children[5]) avatar.group.children[5].rotation.x = swing; // rightLeg
            } else {
                // Si est√° quieto, mantener la rotaci√≥n actual
                if (avatar.group.children[2]) avatar.group.children[2].rotation.x = avatar.group.children[2].rotation.x;
                if (avatar.group.children[3]) avatar.group.children[3].rotation.x = avatar.group.children[3].rotation.x;
                if (avatar.group.children[4]) avatar.group.children[4].rotation.x = avatar.group.children[4].rotation.x;
                if (avatar.group.children[5]) avatar.group.children[5].rotation.x = avatar.group.children[5].rotation.x;
            }
        }

        // Funci√≥n para controlar los eventos del canvas seg√∫n el estado de la UI
        function updateCanvasPointerEvents() {
            const canvas = renderer.domElement;
            const chatOpen = document.getElementById('chat-panel').style.display === 'flex';
            const panelOpen = document.getElementById('simple-panel').style.display === 'block';
            
            if (chatOpen || panelOpen) {
                canvas.style.pointerEvents = 'none';
            } else {
                canvas.style.pointerEvents = 'auto';
            }
        }
    </script>
</body>
</html>