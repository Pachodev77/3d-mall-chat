<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Mall Chat - InfinityFree Version</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }
        
        .ui-button {
            position: fixed;
            padding: 10px 15px;
            background: linear-gradient(135deg, #4B0000, #800000);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            pointer-events: auto;
            z-index: 1000;
        }
        
        #customization-btn {
            top: 20px;
            right: 20px;
        }
        
        #chat-toggle-btn {
            top: 20px;
            right: 150px;
        }
        
        #connection-status {
            top: 20px;
            left: 20px;
            background: #333;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
        }
        
        .connected {
            background: #006400 !important;
        }
        
        .disconnected {
            background: #8B0000 !important;
        }
        
        #simple-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(20,20,20,0.95), rgba(30,30,30,0.95));
            border: 2px solid #FFD700;
            border-radius: 15px;
            padding: 30px;
            z-index: 1001;
            display: none;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .color-btn {
            transition: all 0.3s;
        }
        
        .color-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        #chat-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 500px;
            background: linear-gradient(135deg, rgba(20,20,20,0.95), rgba(30,30,30,0.95));
            border: 2px solid #FFD700;
            border-radius: 15px;
            z-index: 1001;
            display: none;
            flex-direction: column;
        }
        
        #chat-header {
            background: linear-gradient(135deg, #4B0000, #800000);
            color: white;
            padding: 15px;
            border-radius: 13px 13px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        #chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            color: white;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .message.own {
            background: #4B0000;
            margin-left: auto;
        }
        
        .message.user {
            background: #333;
        }
        
        .message.system {
            background: #FFD700;
            color: #000;
            text-align: center;
            max-width: 100%;
        }
        
        #chat-input-area {
            padding: 15px;
            display: flex;
            gap: 10px;
        }
        
        #chat-input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: #333;
            color: white;
        }
        
        #chat-send-btn {
            padding: 10px 15px;
            background: #4B0000;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="ui-overlay">
            <div id="connection-status" class="disconnected">
                Desconectado
            </div>
            <button id="customization-btn" class="ui-button">≡ƒæñ Personalizar</button>
            <button id="chat-toggle-btn" class="ui-button">≡ƒÆ¼ Chat</button>
        </div>
    </div>

    <!-- Panel de personalizaci├│n -->
    <div id="simple-panel">
        <div style="display: flex; gap: 30px; flex-wrap: wrap;">
            <!-- Columna izquierda - Opciones -->
            <div style="flex: 1; min-width: 300px;">
                <!-- Secci├│n de Alias -->
                <div style="padding: 25px; background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(50,50,50,0.8)); border-radius: 12px; border-left: 5px solid #FFD700; box-shadow: 0 4px 16px rgba(0,0,0,0.3); margin-bottom: 25px;">
                    <h3 style="margin: 0 0 20px 0; color: #FFD700; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">≡ƒæñ</span>
                        Tu Nombre
                    </h3>
                    <input type="text" id="simple-alias-input" placeholder="Escribe tu nombre..." style="width: 100%; padding: 12px; border: 2px solid #333; border-radius: 8px; background: rgba(0,0,0,0.5); color: #fff; font-size: 16px; box-sizing: border-box;">
                </div>
                
                <!-- Secci├│n de Colores de Camisa -->
                <div style="padding: 25px; background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(50,50,50,0.8)); border-radius: 12px; border-left: 5px solid #FFD700; box-shadow: 0 4px 16px rgba(0,0,0,0.3); margin-bottom: 25px;">
                    <h3 style="margin: 0 0 20px 0; color: #FFD700; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">≡ƒæò</span>
                        Color de Camisa
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px;">
                        <button onclick="changeShirtColor(0xFF6B6B)" class="color-btn" data-color="0xFF6B6B" style="width: 45px; height: 45px; background: #FF6B6B; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShirtColor(0x4ECDC4)" class="color-btn" data-color="0x4ECDC4" style="width: 45px; height: 45px; background: #4ECDC4; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShirtColor(0x45B7D1)" class="color-btn" data-color="0x45B7D1" style="width: 45px; height: 45px; background: #45B7D1; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShirtColor(0x96CEB4)" class="color-btn" data-color="0x96CEB4" style="width: 45px; height: 45px; background: #96CEB4; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShirtColor(0xFFEAA7)" class="color-btn" data-color="0xFFEAA7" style="width: 45px; height: 45px; background: #FFEAA7; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShirtColor(0xDDA0DD)" class="color-btn" data-color="0xDDA0DD" style="width: 45px; height: 45px; background: #DDA0DD; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShirtColor(0x98D8C8)" class="color-btn" data-color="0x98D8C8" style="width: 45px; height: 45px; background: #98D8C8; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShirtColor(0xF7DC6F)" class="color-btn" data-color="0xF7DC6F" style="width: 45px; height: 45px; background: #F7DC6F; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShirtColor(0xBB8FCE)" class="color-btn" data-color="0xBB8FCE" style="width: 45px; height: 45px; background: #BB8FCE; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShirtColor(0x85C1E9)" class="color-btn" data-color="0x85C1E9" style="width: 45px; height: 45px; background: #85C1E9; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShirtColor(0xF8C471)" class="color-btn" data-color="0xF8C471" style="width: 45px; height: 45px; background: #F8C471; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShirtColor(0x82E0AA)" class="color-btn" data-color="0x82E0AA" style="width: 45px; height: 45px; background: #82E0AA; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                    </div>
                </div>
                
                <!-- Secci├│n de Colores de Pantal├│n -->
                <div style="padding: 25px; background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(50,50,50,0.8)); border-radius: 12px; border-left: 5px solid #FFD700; box-shadow: 0 4px 16px rgba(0,0,0,0.3); margin-bottom: 25px;">
                    <h3 style="margin: 0 0 20px 0; color: #FFD700; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">≡ƒæû</span>
                        Color de Pantal├│n
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px;">
                        <button onclick="changePantsColor(0x2C3E50)" class="color-btn" data-color="0x2C3E50" style="width: 45px; height: 45px; background: #2C3E50; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changePantsColor(0x34495E)" class="color-btn" data-color="0x34495E" style="width: 45px; height: 45px; background: #34495E; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changePantsColor(0x8B4513)" class="color-btn" data-color="0x8B4513" style="width: 45px; height: 45px; background: #8B4513; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changePantsColor(0x654321)" class="color-btn" data-color="0x654321" style="width: 45px; height: 45px; background: #654321; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changePantsColor(0x2F4F4F)" class="color-btn" data-color="0x2F4F4F" style="width: 45px; height: 45px; background: #2F4F4F; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changePantsColor(0x696969)" class="color-btn" data-color="0x696969" style="width: 45px; height: 45px; background: #696969; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changePantsColor(0x556B2F)" class="color-btn" data-color="0x556B2F" style="width: 45px; height: 45px; background: #556B2F; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changePantsColor(0x8B0000)" class="color-btn" data-color="0x8B0000" style="width: 45px; height: 45px; background: #8B0000; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changePantsColor(0x4B0082)" class="color-btn" data-color="0x4B0082" style="width: 45px; height: 45px; background: #4B0082; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changePantsColor(0x191970)" class="color-btn" data-color="0x191970" style="width: 45px; height: 45px; background: #191970; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changePantsColor(0x006400)" class="color-btn" data-color="0x006400" style="width: 45px; height: 45px; background: #006400; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changePantsColor(0x000000)" class="color-btn" data-color="0x000000" style="width: 45px; height: 45px; background: #000000; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                    </div>
                </div>
                
                <!-- Secci├│n de Colores de Zapatos -->
                <div style="padding: 25px; background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(50,50,50,0.8)); border-radius: 12px; border-left: 5px solid #FFD700; box-shadow: 0 4px 16px rgba(0,0,0,0.3);">
                    <h3 style="margin: 0 0 20px 0; color: #FFD700; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">≡ƒæ₧</span>
                        Color de Zapatos
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px;">
                        <button onclick="changeShoesColor(0x8B4513)" class="color-btn" data-color="0x8B4513" style="width: 45px; height: 45px; background: #8B4513; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShoesColor(0x654321)" class="color-btn" data-color="0x654321" style="width: 45px; height: 45px; background: #654321; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShoesColor(0x000000)" class="color-btn" data-color="0x000000" style="width: 45px; height: 45px; background: #000000; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShoesColor(0x2F4F4F)" class="color-btn" data-color="0x2F4F4F" style="width: 45px; height: 45px; background: #2F4F4F; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShoesColor(0x696969)" class="color-btn" data-color="0x696969" style="width: 45px; height: 45px; background: #696969; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShoesColor(0x8B0000)" class="color-btn" data-color="0x8B0000" style="width: 45px; height: 45px; background: #8B0000; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShoesColor(0x4B0082)" class="color-btn" data-color="0x4B0082" style="width: 45px; height: 45px; background: #4B0082; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                        <button onclick="changeShoesColor(0x191970)" class="color-btn" data-color="0x191970" style="width: 45px; height: 45px; background: #191970; border: 3px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;"></button>
                    </div>
                </div>
            </div>
            
            <!-- Columna derecha - Vista previa -->
            <div style="display: flex; flex-direction: column; gap: 25px;">
                <!-- Vista previa del avatar -->
                <div style="padding: 25px; background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(50,50,50,0.8)); border-radius: 12px; border-left: 5px solid #FFD700; box-shadow: 0 4px 16px rgba(0,0,0,0.3); text-align: center;">
                    <h3 style="margin: 0 0 20px 0; color: #FFD700; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 20px;">≡ƒæñ</span>
                        Vista Previa
                    </h3>
                    <div id="avatar-preview" style="width: 150px; height: 200px; margin: 0 auto; position: relative; background: linear-gradient(135deg, rgba(20,20,20,0.5), rgba(30,30,30,0.5)); border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid #333;">
                        <div style="color: #ccc; font-size: 14px;">Avatar en tiempo real</div>
                    </div>
                </div>
                
                <!-- Informaci├│n del alias -->
                <div style="padding: 25px; background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(50,50,50,0.8)); border-radius: 12px; border-left: 5px solid #FFD700; box-shadow: 0 4px 16px rgba(0,0,0,0.3); text-align: center;">
                    <h3 style="margin: 0 0 20px 0; color: #FFD700; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 20px;">≡ƒô¥</span>
                        Nombre Actual
                    </h3>
                    <div id="preview-alias" style="color: #fff; font-size: 18px; font-weight: bold; padding: 15px; background: linear-gradient(135deg, rgba(0,0,0,0.5), rgba(20,20,20,0.5)); border-radius: 8px; border: 2px solid #FFD700; min-height: 20px;">Sin nombre</div>
                </div>
            </div>
        </div>
        
        <!-- Footer con botones -->
        <div style="padding: 20px 30px; background: linear-gradient(135deg, rgba(34,34,34,0.95), rgba(44,44,44,0.95)); border-top: 2px solid #333; display: flex; gap: 15px; justify-content: flex-end;">
            <button onclick="resetSimpleCustomization()" style="padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; background: linear-gradient(135deg, #555, #777); color: #fff; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">≡ƒöä Restablecer</button>
            <button onclick="saveSimpleCustomization()" style="padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; background: linear-gradient(135deg, #4B0000, #800000); color: #fff; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">≡ƒÆ╛ Guardar</button>
        </div>
    </div>

    <!-- Panel de chat -->
    <div id="chat-panel">
        <div id="chat-header">
            Chat
            <button class="close-btn" onclick="closeChat()">Γ£û</button>
        </div>
        <div id="chat-content">
            <div id="chat-messages"></div>
            <div id="chat-input-area">
                <input id="chat-input" type="text" placeholder="Escribe un mensaje..." autocomplete="off" />
                <button id="chat-send-btn">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v11 -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjPYZJeoLgisI3KZyA6_0OwmH_UESGR14",
            authDomain: "ccapp-b8301.firebaseapp.com",
            projectId: "ccapp-b8301",
            storageBucket: "ccapp-b8301.firebasestorage.app",
            messagingSenderId: "622692105172",
            appId: "1:622692105172:web:dceecda5e2a54630d4b441",
            measurementId: "G-5DW5PB2RB6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);

        // Referencias a la base de datos
        const usersRef = ref(db, 'users');
        const messagesRef = ref(db, 'messages');
        const positionsRef = ref(db, 'positions');

        // Variables globales
        let currentUser = null;
        let isConnected = false;

        // Funci├│n para conectar al chat
        window.connectToChat = function(alias) {
            if (!alias || alias.trim().length === 0) {
                alert('Por favor ingresa un alias v├ílido');
                return;
            }
            
            currentUser = {
                alias: alias.trim(),
                position: { x: 25, y: 1.6, z: 25 },
                floor: 0,
                rotation: 0,
                timestamp: Date.now()
            };
            
            // Guardar usuario en Firebase
            set(ref(db, `users/${currentUser.alias}`), currentUser);
            
            // Escuchar cambios en usuarios
            onValue(usersRef, (snapshot) => {
                const users = snapshot.val() || {};
                updateUsersList(Object.values(users));
            });
            
            // Escuchar mensajes
            onChildAdded(messagesRef, (snapshot) => {
                const message = snapshot.val();
                if (message.alias !== currentUser.alias) {
                    addMessageToChat(message.alias, message.message, 'user');
                }
            });
            
            // Escuchar posiciones
            onValue(positionsRef, (snapshot) => {
                const positions = snapshot.val() || {};
                Object.keys(positions).forEach(alias => {
                    if (alias !== currentUser.alias) {
                        const userData = positions[alias];
                        updateAvatarPosition(alias, userData.position, userData.floor, userData.rotation);
                    }
                });
            });
            
            isConnected = true;
            console.log('Conectado al chat como:', currentUser.alias);
        };

        // Funci├│n para enviar mensaje
        window.sendMessage = function(message) {
            if (!isConnected || !currentUser) return;
            
            const messageData = {
                alias: currentUser.alias,
                message: message,
                timestamp: Date.now()
            };
            
            push(messagesRef, messageData);
            addMessageToChat(currentUser.alias, message, 'own');
        };

        // Funci├│n para enviar posici├│n
        window.sendPosition = function(position, floor, rotation) {
            if (!isConnected || !currentUser) return;
            
            const positionData = {
                position: position,
                floor: floor,
                rotation: rotation,
                timestamp: Date.now()
            };
            
            set(ref(db, `positions/${currentUser.alias}`), positionData);
        };

        // Funci├│n para desconectar
        window.disconnectFromChat = function() {
            if (currentUser) {
                remove(ref(db, `users/${currentUser.alias}`));
                remove(ref(db, `positions/${currentUser.alias}`));
                currentUser = null;
            }
            isConnected = false;
        };

        // Funci├│n para actualizar lista de usuarios
        function updateUsersList(users) {
            const usersList = document.getElementById('users-list');
            if (usersList) {
                usersList.innerHTML = '';
                users.forEach(user => {
                    if (user.alias !== currentUser?.alias) {
                        const userElement = document.createElement('div');
                        userElement.className = 'user-item';
                        userElement.textContent = user.alias;
                        usersList.appendChild(userElement);
                    }
                });
            }
        }

        // Funci├│n para limpiar mensajes antiguos (mantener solo los ├║ltimos 100)
        function cleanupOldMessages() {
            onValue(messagesRef, (snapshot) => {
                const messages = snapshot.val();
                if (messages) {
                    const messageKeys = Object.keys(messages);
                    if (messageKeys.length > 100) {
                        const keysToDelete = messageKeys.slice(0, messageKeys.length - 100);
                        keysToDelete.forEach(key => {
                            remove(ref(db, `messages/${key}`));
                        });
                    }
                }
            }, { onlyOnce: true });
        }

        // Limpiar mensajes antiguos cada 5 minutos
        setInterval(cleanupOldMessages, 5 * 60 * 1000);

        // Limpiar usuarios desconectados (m├ís de 30 segundos sin actividad)
        function cleanupDisconnectedUsers() {
            const now = Date.now();
            onValue(usersRef, (snapshot) => {
                const users = snapshot.val();
                if (users) {
                    Object.keys(users).forEach(alias => {
                        const user = users[alias];
                        if (now - user.timestamp > 30000) { // 30 segundos
                            remove(ref(db, `users/${alias}`));
                            remove(ref(db, `positions/${alias}`));
                        }
                    });
                }
            }, { onlyOnce: true });
        }

        // Limpiar usuarios desconectados cada 10 segundos
        setInterval(cleanupDisconnectedUsers, 10000);

        // Hacer funciones disponibles globalmente
        window.isConnected = () => isConnected;
        window.currentUser = () => currentUser;
    </script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        // Variables globales
        let scene, camera, renderer;
        let userAlias = '';
        let shirtColor = 0xFF6B6B;
        let pantsColor = 0x2C3E50;
        let shoesColor = 0x8B4513;
        let chatOpen = false;
        let customizationPanelOpen = false;
        
        // Inicializar la aplicaci├│n
        function init() {
            console.log('Inicializando aplicaci├│n 3D Mall Chat...');
            
            // Configurar Three.js
            setupThreeJS();
            
            // Configurar controles
            setupControls();
            
            // Configurar eventos
            setupEventListeners();
            
            // Cargar personalizaci├│n guardada
            loadCustomization();
            
            // Iniciar renderizado
            animate();
            
            console.log('Γ£à Aplicaci├│n inicializada correctamente');
        }
        
        // Configurar Three.js
        function setupThreeJS() {
            // Crear escena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            
            // Crear c├ímara
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(25, 5, 25);
            
            // Crear renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('container').appendChild(renderer.domElement);
            
            // Crear mundo 3D b├ísico
            createWorld();
        }
        
        // Crear mundo 3D
        function createWorld() {
            // Crear suelo
            const groundGeometry = new THREE.PlaneGeometry(100, 100);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x90EE90 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // Crear iluminaci├│n
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 50, 50);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
        }
        
        // Configurar controles
        function setupControls() {
            // Aqu├¡ ir├¡an los controles de movimiento
            // Por simplicidad, solo configuramos eventos b├ísicos
        }
        
        // Configurar eventos
        function setupEventListeners() {
            // Bot├│n de personalizaci├│n
            document.getElementById('customization-btn').addEventListener('click', openCustomizationPanel);
            
            // Bot├│n de chat
            document.getElementById('chat-toggle-btn').addEventListener('click', toggleChat);
            
            // Input de chat
            document.getElementById('chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            // Bot├│n enviar chat
            document.getElementById('chat-send-btn').addEventListener('click', sendChatMessage);
            
            // Redimensionar ventana
            window.addEventListener('resize', onWindowResize);
        }
        
        // Funciones de personalizaci├│n
        function changeShirtColor(color) {
            shirtColor = color;
            updateAvatarPreview();
            updateColorButtonSelection('shirt', color);
        }
        
        function changePantsColor(color) {
            pantsColor = color;
            updateAvatarPreview();
            updateColorButtonSelection('pants', color);
        }
        
        function changeShoesColor(color) {
            shoesColor = color;
            updateAvatarPreview();
            updateColorButtonSelection('shoes', color);
        }
        
        function updateColorButtonSelection(type, selectedColor) {
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.style.borderColor = 'transparent';
                btn.style.transform = 'scale(1)';
            });
            
            const selectedBtn = document.querySelector(`[data-color="${selectedColor}"]`);
            if (selectedBtn) {
                selectedBtn.style.borderColor = '#FFD700';
                selectedBtn.style.transform = 'scale(1.1)';
                selectedBtn.style.boxShadow = '0 0 10px rgba(255, 215, 0, 0.5)';
            }
        }
        
        function updateAvatarPreview() {
            const previewDiv = document.getElementById('avatar-preview');
            const aliasPreview = document.getElementById('preview-alias');
            const aliasInput = document.getElementById('simple-alias-input');
            
            if (previewDiv && aliasPreview) {
                const currentAlias = aliasInput ? aliasInput.value.trim() : userAlias;
                aliasPreview.textContent = currentAlias || 'Sin nombre';
                
                const shirtColorHex = shirtColor.toString(16).padStart(6, '0');
                const pantsColorHex = pantsColor.toString(16).padStart(6, '0');
                const shoesColorHex = shoesColor.toString(16).padStart(6, '0');
                
                previewDiv.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px; position: relative;">
                        <!-- Cabeza -->
                        <div style="width: 40px; height: 40px; background: #FFE4C4; border: 2px solid #333; border-radius: 4px; position: relative;">
                            <!-- Ojos -->
                            <div style="position: absolute; top: 8px; left: 8px; width: 6px; height: 6px; background: #000; border-radius: 50%;"></div>
                            <div style="position: absolute; top: 8px; right: 8px; width: 6px; height: 6px; background: #000; border-radius: 50%;"></div>
                        </div>
                        
                        <!-- Torso (camisa) -->
                        <div style="width: 50px; height: 60px; background: #${shirtColorHex}; border: 2px solid #333; border-radius: 4px; position: relative;">
                            <!-- Brazos -->
                            <div style="position: absolute; top: 10px; left: -8px; width: 12px; height: 40px; background: #${shirtColorHex}; border: 2px solid #333; border-radius: 4px;"></div>
                            <div style="position: absolute; top: 10px; right: -8px; width: 12px; height: 40px; background: #${shirtColorHex}; border: 2px solid #333; border-radius: 4px;"></div>
                            <!-- Manos -->
                            <div style="position: absolute; bottom: -8px; left: -8px; width: 12px; height: 12px; background: #FFE4C4; border: 2px solid #333; border-radius: 4px;"></div>
                            <div style="position: absolute; bottom: -8px; right: -8px; width: 12px; height: 12px; background: #FFE4C4; border: 2px solid #333; border-radius: 4px;"></div>
                        </div>
                        
                        <!-- Pantalones -->
                        <div style="width: 50px; height: 50px; background: #${pantsColorHex}; border: 2px solid #333; border-radius: 4px; position: relative;">
                            <!-- Piernas -->
                            <div style="position: absolute; bottom: -8px; left: 8px; width: 12px; height: 30px; background: #${pantsColorHex}; border: 2px solid #333; border-radius: 4px;"></div>
                            <div style="position: absolute; bottom: -8px; right: 8px; width: 12px; height: 30px; background: #${pantsColorHex}; border: 2px solid #333; border-radius: 4px;"></div>
                        </div>
                        
                        <!-- Zapatos -->
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <div style="width: 16px; height: 8px; background: #${shoesColorHex}; border: 2px solid #333; border-radius: 2px;"></div>
                            <div style="width: 16px; height: 8px; background: #${shoesColorHex}; border: 2px solid #333; border-radius: 2px;"></div>
                        </div>
                        
                        <!-- Nombre del avatar -->
                        <div style="color: #FFD700; font-size: 12px; font-weight: bold; text-align: center; margin-top: 8px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${currentAlias || 'Sin nombre'}</div>
                    </div>
                `;
            }
        }
        
        function resetSimpleCustomization() {
            shirtColor = 0xFF6B6B;
            pantsColor = 0x2C3E50;
            shoesColor = 0x8B4513;
            
            userAlias = '';
            const aliasInput = document.getElementById('simple-alias-input');
            if (aliasInput) {
                aliasInput.value = '';
            }
            
            updateAvatarPreview();
            
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.style.borderColor = 'transparent';
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = 'none';
            });
        }
        
        function saveSimpleCustomization() {
            const aliasInput = document.getElementById('simple-alias-input');
            const newAlias = aliasInput ? aliasInput.value.trim() : '';
            
            if (newAlias.length > 20) {
                alert('El nombre no puede tener m├ís de 20 caracteres');
                return;
            }
            
            userAlias = newAlias;
            
            const customizationData = {
                alias: userAlias,
                shirtColor: shirtColor,
                pantsColor: pantsColor,
                shoesColor: shoesColor
            };
            
            localStorage.setItem('avatarCustomization', JSON.stringify(customizationData));
            
            // Conectar al chat con el nuevo alias
            if (userAlias) {
                window.connectToChat(userAlias);
                updateConnectionStatus(true);
            }
            
            closeSimplePanel();
        }
        
        function loadCustomization() {
            const saved = localStorage.getItem('avatarCustomization');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    userAlias = data.alias || '';
                    shirtColor = data.shirtColor || 0xFF6B6B;
                    pantsColor = data.pantsColor || 0x2C3E50;
                    shoesColor = data.shoesColor || 0x8B4513;
                    
                    const aliasInput = document.getElementById('simple-alias-input');
                    if (aliasInput) {
                        aliasInput.value = userAlias;
                    }
                    
                    updateAvatarPreview();
                } catch (error) {
                    console.error('Error cargando personalizaci├│n:', error);
                }
            }
        }
        
        function openCustomizationPanel() {
            const simplePanel = document.getElementById('simple-panel');
            if (simplePanel) {
                simplePanel.style.display = 'block';
                customizationPanelOpen = true;
                updateAvatarPreview();
            }
        }
        
        function closeSimplePanel() {
            const panel = document.getElementById('simple-panel');
            if (panel) {
                panel.style.display = 'none';
                customizationPanelOpen = false;
            }
        }
        
        // Funciones de chat
        function toggleChat() {
            const chatPanel = document.getElementById('chat-panel');
            if (chatOpen) {
                chatPanel.style.display = 'none';
                chatOpen = false;
            } else {
                chatPanel.style.display = 'flex';
                chatOpen = true;
                document.getElementById('chat-input').focus();
            }
        }
        
        function closeChat() {
            const chatPanel = document.getElementById('chat-panel');
            chatPanel.style.display = 'none';
            chatOpen = false;
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (message && window.isConnected()) {
                window.sendMessage(message);
                input.value = '';
            } else if (!window.isConnected()) {
                alert('Debes personalizar tu avatar y conectarte primero');
            }
        }
        
        function addMessageToChat(alias, message, type) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.innerHTML = `<strong>${alias}:</strong> ${message}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (connected) {
                statusElement.textContent = 'Conectado';
                statusElement.className = 'connected';
            } else {
                statusElement.textContent = 'Desconectado';
                statusElement.className = 'disconnected';
            }
        }
        
        function updateAvatarPosition(alias, position, floor, rotation) {
            // Esta funci├│n se usar├¡a para actualizar posiciones de otros usuarios
            // Por ahora solo la dejamos vac├¡a para evitar errores
            console.log(`Avatar ${alias} en posici├│n:`, position, floor, rotation);
        }
        
        // Funciones de utilidad
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        
        // Inicializar cuando el DOM est├⌐ listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html> 
